{% extends "base.html" %}
{% load static %}

{% block title %}Language data{% endblock %}
{% block breadcrumb %}Languages / {{ language.id }} / Data{% endblock %}

{% block content %}
<main class="{% with s=lang_status.overall %}{% if not is_admin and s == 'waiting' or not is_admin and s == 'waiting_for_approval' or not is_admin and s == 'approved' or not is_admin and s == 'rejected' %}is-readonly{% endif %}{% endwith %}">
  <div class="card">
    <h2>{{ language.name_full }} ({{ language.id }})</h2>
    <!-- <p class="muted">Compila o modifica le risposte. Ogni pulsante “Save” salva solo il parametro aperto.</p> -->
  </div>

  {# === Stato e azioni workflow === #}
  <div class="card" style="margin-top:.5rem">
    <div class="grid grid-2">
      <div>
        <strong>Status:</strong>
        {% with s=lang_status.overall %}
          {% if s == "approved" %}
            <span class="badge b-ok">Approved</span>
          {% elif s == "waiting" or s == "waiting_for_approval" %}
            <span class="badge">Waiting for approval</span>
          {% elif s == "rejected" %}
            <span class="badge b-warn">Rejected</span>
          {% else %}
            <span class="badge b-warn">Pending</span>
          {% endif %}
        {% endwith %}

        {% if last_reject %}
          {% with s=lang_status.overall %}
            {% if is_admin or s != 'approved' %}
              <div class="muted" style="margin-top:.25rem">
                Ultimo rifiuto: {{ last_reject.created_at|date:"Y-m-d H:i" }} —
                {% if last_reject.message %}“{{ last_reject.message }}”{% else %}<em>nessun messaggio</em>{% endif %}
              </div>
            {% endif %}
          {% endwith %}
        {% endif %}
      </div>

      <div class="toolbar" style="justify-content:flex-end; gap:.5rem; flex-wrap:wrap">
  {% if is_admin %}
          <!-- === Toolbar ADMIN  === -->
          <div style="display:flex; gap:1rem; align-items:flex-start; flex-wrap:wrap;">
            <form id="submission-create-form"
                  method="post"
                  action="{% url 'submission_create_for_language' language.id %}"
                  {% if not all_answered %}data-confirm-missing="1"{% endif %}
                  data-confirm-message="Warning: missing answers. Save anyway?">
              {% csrf_token %}
              <input type="hidden" name="next" value="{{ request.get_full_path }}">
              <div style="display:flex; flex-direction:column; align-items:flex-start; gap:.3rem;">
                <button type="submit" class="btn" data-once="true" title="Crea una nuova submission con lo stato attuale della lingua">Save language</button>
                <details>
                  <summary>Submission's note</summary>
                  <div style="margin-top:.25rem; max-width:100%">
                    <label for="note_{{ language.id }}" class="sr-only">Submission's note</label>
                    <textarea id="note_{{ language.id }}" name="note" rows="2" style="min-width:18rem; max-width:100%"></textarea>
                  </div>
                </details>
              </div>
            </form>

            <form method="post" action="{% url 'language_reject' language.id %}">
              {% csrf_token %}
              <div style="display:flex; flex-direction:column; align-items:flex-start; gap:.3rem;">
                <button type="submit" class="btn" title="Rifiuta la submission della lingua">Reject</button>
                <details>
                  <summary>Rejection's note</summary>
                  <div style="margin-top:.25rem; max-width:100%">
                    <label for="reject_message_{{ language.id }}" class="sr-only">Rejection's note</label>
                    <textarea id="reject_message_{{ language.id }}" name="message" rows="2" style="min-width:18rem; max-width:100%"></textarea>
                  </div>
                </details>
              </div>
            </form>
            
            <!-- Download Excel (Examples per tutti; Answers solo per admin) -->
            <div style="display:flex; flex-direction:column; align-items:flex-start; gap:.3rem;">
              <a href="{% url 'language_export_xlsx' language.id %}"
                 class="btn"
                 title="Download .xlsx">
                Download Excel
              </a>
              <!-- <small class="muted">Download .xlsx</small> -->
            </div>


            <form method="post" action="{% url 'language_approve' language.id %}">
              {% csrf_token %}
              <div style="display:flex; flex-direction:column; align-items:flex-start; gap:.3rem;">
                {% if not all_answered %}
                  <span class="hint-disabled" title="Cannot approve while there are missing answers" tabindex="0">
                    <button type="submit" class="btn btn--primary" disabled aria-disabled="true">Approve &amp; apply implications</button>
                  </span>
                {% else %}
                  <button type="submit" class="btn btn--primary">Approve &amp; apply implications</button>
                {% endif %}
              </div>
            </form>
          </div>
        {% else %}
          <!-- === Toolbar USER  === -->
          {% with s=lang_status.overall %}
            {% if s == 'rejected' %}
              <!-- Quando c'è stato un reject dell'admin: mostra SOLO REOPEN -->
              <form method="post" action="{% url 'language_reopen' language.id %}">
                {% csrf_token %}
                <button type="submit" class="btn btn--primary">Reopen</button>
                <span class="locked-hint">La lingua è stata rifiutata: premi “Reopen” per riaprire la modifica.</span>
              </form>
            {% elif s == 'pending' %}
              <!-- Stato normale di compilazione: mostra SUBMIT -->
              <form method="post" action="{% url 'language_submit' language.id %}">
                {% csrf_token %}
                <button type="submit" class="btn btn--primary">Submit for review</button>
              </form>
            {% else %}
              <!-- waiting_for_approval / approved: nessuna azione, bottone disabilitato -->
              <span class="hint-disabled" title="{% if s == 'waiting_for_approval' or s == 'waiting' %}In attesa di revisione dell'admin{% else %}Già approvata dall'admin{% endif %}" tabindex="0">
                <button type="button" class="btn" disabled aria-disabled="true">Submit for review</button>
              </span>

              <!-- Download Excel  -->
            <a href="{% url 'language_export_xlsx' language.id %}"
               class="btn"
               title="Download .xlsx">
              Download .xlsx
            </a>
            {% endif %}
          {% endwith %}
        {% endif %}
      </div>

    </div> 
  </div>    

  <!-- Barra di navigazione parametri -->
  <div class="param-nav" id="paramNav">
    {% for p in parameters %}
      <div
        class="param-btn"
        data-target="p-{{ p.id }}"
        data-status="{{ p.status }}"
        style="background:{{ p.bg_color }}; color:{{ p.fg_color }};"
        role="button"
        tabindex="0"
        title="Parameter {{ p.id }} — ..."
        aria-label="Parameter {{ p.id }}, ...">
        <span class="badge-review" aria-hidden="true" hidden>!</span> 
        {{ p.id }} 
      </div>

    {% endfor %}
  </div>

  {% for p in parameters %}
  <section id="p-{{ p.id }}" class="param-section card">
    <h3 class="param-title">
  {{ p.id }} — {{ p.name }}
  <label class="review-flag">
    <input
      type="checkbox"
      class="review-flag-input"
      data-param="{{ p.id }}"
      data-lang="{{ language.id }}"
      aria-label="Mark {{ p.id }} as 'to review'">
    <!-- <span class="pill pill--warn" aria-hidden="true">!</span> -->
    <span class="muted small">Mark as needs review</span>
  </label>
</h3>
    {% if p.short_description %}
      <p class="muted">{{ p.short_description }}</p>
    {% endif %}

    <form method="post" action="{% url 'parameter_save' language.id p.id %}">
      {% csrf_token %}
      {% for q in p.questions.all %}
        <div class="card" style="margin-bottom:.5rem">
          <p><strong>{{ q.id }}</strong> — {{ q.text }}</p>

          {% if q.example_yes %}
            <div class="muted" style="margin:.25rem 0 .5rem;">
              <strong>Example YES:</strong> {{ q.example_yes|linebreaksbr }}
            </div>
          {% endif %}

          {% if q.instruction %}
            <div class="muted" style="margin:.25rem 0 .5rem;">
              <strong>Instructions:</strong> {{ q.instruction|linebreaksbr }}
            </div>
          {% endif %}


          {% if q.help_info %}
          <details class="help-info">
            <summary><span aria-hidden="true">❓</span> More info</summary>
            <div class="muted">{{ q.help_info|linebreaksbr }}</div>
          </details>
        {% endif %}


          <div class="qa-fields">
            <div>
              <label for="resp_{{ q.id }}">Answer</label>
              <select id="resp_{{ q.id }}" name="resp_{{ q.id }}" class="resp-select" data-qid="{{ q.id }}">
                <option value="" {% if q.ans.response_text == "" %}selected{% endif %}>— seleziona —</option>
                <option value="yes" {% if q.ans.response_text == "yes" %}selected{% endif %}>YES</option>
                <option value="no"  {% if q.ans.response_text == "no"  %}selected{% endif %}>NO</option>
              </select>
            </div>

            <div>
              <label for="com_{{ q.id }}">Comments</label>
              <textarea id="com_{{ q.id }}" name="com_{{ q.id }}" rows="2"
                        class="auto-grow"
                        data-autosize="1">{{ q.ans.comments }}</textarea>
            </div>

            

          </div>


          <div class="examples-block" data-qid="{{ q.id }}"
              data-template="{{ q.template_type|default:'linear' }}"
              {% if q.ans.response_text == "" %}style="display:none"{% endif %}>

            <div class="toolbar" style="margin:.5rem 0">
              <strong>Examples</strong>
            </div>
            <p class="muted" style="margin:.25rem 0 .5rem;">
              Please provide the ungrammatical example. If the example cannot be provided, select the appropriate motivation(s) below.
            </p>

            <div class="examples-list" data-qid="{{ q.id }}">
              {% for ex in q.ans.examples %}
              <div class="card example-row" style="margin-bottom:.5rem">
                <div class="grid">
                  <div><label>Number</label><input name="ex_{{ ex.id }}_number" value="{{ ex.number }}"></div>
                  <div><label>Example text</label><input name="ex_{{ ex.id }}_textarea" value="{{ ex.textarea }}"></div>
                  <div><label>Transliteration</label><input name="ex_{{ ex.id }}_transliteration" value="{{ ex.transliteration }}"></div>
                  <div><label>Gloss</label><input name="ex_{{ ex.id }}_gloss" value="{{ ex.gloss }}"></div>
                  <div><label>English Translation</label><input name="ex_{{ ex.id }}_translation" value="{{ ex.translation }}"></div>
                  <div><label>Reference</label><input name="ex_{{ ex.id }}_reference" value="{{ ex.reference }}"></div>
                </div>
                <div class="toolbar" style="margin-top:.25rem">
                  <input type="hidden" name="del_ex_{{ ex.id }}" value="0">
                  <button class="btn btn-ex-toggle-delete"
                          type="button"
                          data-qid="{{ q.id }}"
                          data-exid="{{ ex.id }}"
                          {% with s=lang_status.overall %}
                            {% if not is_admin and s == 'waiting' or not is_admin and s == 'waiting_for_approval' or not is_admin and s == 'approved' or not is_admin and s == 'rejected' %}
                              disabled aria-disabled="true" title="Editing bloccato fino alla revisione"
                            {% endif %}
                          {% endwith %}
                  >Delete</button>

                </div>
              </div>
              {% empty %}
              <div class="muted">No examples yet</div>
              {% endfor %}
            </div>

            <div>
              <button class="btn add-example-btn" type="button" data-qid="{{ q.id }}"
                {% with s=lang_status.overall %}
                  {% if not is_admin and s == 'waiting' or not is_admin and s == 'waiting_for_approval' or not is_admin and s == 'approved' or not is_admin and s == 'rejected' %}
                    disabled aria-disabled="true" title="Editing bloccato fino alla revisione"
                  {% endif %}
                {% endwith %}
              >Add example</button>
            </div>

          </div>

          {# --- MOTIVATIONS (solo quando risposta == NO) --- #}
            <div class="mot-block" data-qid="{{ q.id }}" {% if q.ans.response_text != "no" %}style="display:none"{% endif %}>
              <div class="muted" style="margin-bottom:.25rem">
                Select one or more motivations (if applicable).
              </div>

              <fieldset class="mot-checklist" aria-label="Motivations for NO" data-qid="{{ q.id }}">
                {% for m in q.allowed_motivations_list %}
                  <label class="checkbox-item" style="display:flex;gap:.5rem;align-items:flex-start;margin:.2rem 0;">
                    <input
                      type="checkbox"
                      name="mot_{{ q.id }}"
                      value="{{ m.id }}"
                      data-exclusive="{% if m.code == 'MOT1' %}1{% else %}0{% endif %}"
                      {% if m.id in q.ans.motivation_ids %}checked{% endif %}
                      {% with s=lang_status.overall %}
                        {% if not is_admin and s == 'waiting' or not is_admin and s == 'waiting_for_approval' or not is_admin and s == 'approved' or not is_admin and s == 'rejected' %}
                          disabled aria-disabled="true"
                        {% endif %}
                      {% endwith %}
                    >
                    <span>
                      <span>
                        <strong>{{ m.label|default:m.code }}</strong>
                      </span>

                    </span>

                  </label>
                {% empty %}
                  <div class="muted">No motivations configured for this question.</div>
                {% endfor %}
              </fieldset>
            </div>

        </div>
      {% endfor %}

      <div class="toolbar" style="margin-top:.5rem">
        <button type="submit" class="btn btn--primary"
          {% with s=lang_status.overall %}
            {% if not is_admin and s == 'waiting' or not is_admin and s == 'waiting_for_approval' or not is_admin and s == 'approved' or not is_admin and s == 'rejected' %}
              disabled aria-disabled="true" title="Editing bloccato fino alla revisione"
            {% endif %}
          {% endwith %}
        >Save {{ p.id }}</button>
      </div>
    </form>
  </section>
  {% endfor %}
</main>
{% endblock %}

{% block extra_head %}
  <script src="{% static 'js/param_organize.js' %}"></script>
  <script src="{% static 'js/examples.js' %}"></script>
  <script src="{% static 'js/submission_create.js' %}"></script>
  <script src="{% static 'js/autosize_textarea.js' %}"></script>

  <style>
    .param-nav {display:flex; flex-wrap:wrap; gap:.4rem; margin-bottom:1rem;}
    .param-btn {
      width:2.4rem; height:2.4rem; border-radius:4px;
      display:flex; align-items:center; justify-content:center;
      cursor:pointer; font-weight:bold; border:2px solid rgba(0,0,0,.65);
      transition:transform .1s; position:relative;
      background-clip: padding-box;
    }
    .param-btn:hover {transform:scale(1.1);}
    .param-section {display:none;}
    .param-section.active {display:block;}

    /* === BLOCCO VISIVO (solo grafico) === */
    .is-readonly .card input,
    .is-readonly .card select,
    .is-readonly .card textarea {
      background: var(--surface-2, #f1f3f5);
      color: var(--muted-fg, #666);
      border-color: var(--border, #d0d7de);
      pointer-events: none;
    }
    .is-readonly .card input::placeholder,
    .is-readonly .card textarea::placeholder { color: #999; }
    .is-readonly .btn,
    .is-readonly .add-example-btn,
    .is-readonly .btn-ex-toggle-delete {
      opacity: .55; cursor: not-allowed; pointer-events: none;
    }
    .locked-hint { font-size: .9rem; color: #666; margin-left: .5rem; }
    .hint-disabled[title] { cursor: help; display: inline-block; }
    .is-readonly form[action$="reopen/"] .btn { opacity: 1; pointer-events: auto; cursor: pointer; }
/* --------- Accessibilità stati parametri --------- */

/* Colore bordo */
.param-nav .param-btn {
  --edge: color-mix(in srgb, currentColor 55%, black);
}

/* PARZIALE (gialli) -> view usa 'warn' : bordo tratteggiato */
.param-nav .param-btn[data-status="warn"] {
  border: 2px dashed var(--edge);
  border-radius: 4px;
  position: relative;      
}

/* MANCANTI (rossi):  */
.param-nav .param-btn[data-status="missing"] {
  border: 2px solid var(--edge);
  border-radius: 4px;
  position: relative;
  overflow: visible;  
}


/* === PARAMETRI OK (verdi) — forma circolare === */
.param-nav .param-btn[data-status="ok"],
.param-nav .param-btn:not([data-status]) {
  border: 2px solid var(--edge);
  border-radius: 50%;     
  position: relative;
  overflow: visible;    
}


/* Preferenze utente alta visibilità */
@media (prefers-contrast: more) {
  .param-nav .param-btn[data-status="warn"] { border-width: 3px; }
  .param-nav .param-btn[data-status="missing"] { border-color: #000; }
  .param-nav .param-btn[data-status="ok"] { border-color: #000; }
}

/* Stacking verticale dei tre campi */
  .qa-fields {
    display: flex;
    flex-direction: column;
    gap: .75rem;
  }

  /* Textarea auto-espandibile, con limiti ragionevoli per mobile */
  textarea.auto-grow {
    width: 100%;
    min-height: 2.5rem;   /* parte piccola */
    max-height: 40vh;     /* non far esplodere la pagina */
    overflow: hidden;     /* niente scrollbar mentre cresce */
    resize: vertical;     /* l'utente può comunque allungarla se vuole */
  }

  /* Accessibilità: focus ben visibile */
  textarea.auto-grow:focus {
    outline: 2px solid var(--focus, #2266ff);
    outline-offset: 2px;
  }
/* === Badge "to review" — pallino rosso a SINISTRA === */
.param-btn { position: relative; }

.param-btn .badge-review {
  position: absolute;
  top: -6px;
  left: -6px;          /* ← spostato a sinistra */
  width: 14px;
  height: 14px;
  border-radius: 50%;
  background: var(--bad, #b00020);  /* rosso */
  border: 2px solid #fff;
  box-shadow: 0 0 0 1px rgba(0,0,0,.15);
  z-index: 2;
}

:root[data-theme="dark"] .param-btn .badge-review {
  border-color: var(--surface, #1e1f22);
}

@media (min-width: 1200px) {
  .param-btn .badge-review { width: 16px; height: 16px; top: -7px; left: -7px; }
}
/* forza il nascondimento quando c'è l'attributo hidden */
.badge-review[hidden] { 
  display: none !important;
}


</style>
{% endblock %}
{% block extra_js %}
<script>
// CSRF
function getCookie(name) {
  const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
  return m ? m.pop() : '';
}
const csrftoken = getCookie('csrftoken');

document.querySelectorAll('.badge-review').forEach(b => b.hidden = true);

// A) Fetch dei flag per l'utente corrente su questa lingua
(async function initReviewFlags(){
  try {
    const url = "{% url 'review_flags_list' language.id %}";
    const resp = await fetch(url, { headers: { 'Accept': 'application/json' }});
    if (!resp.ok) return;
    const data = await resp.json();  // { flags: ["FGM", "FGA", ...] }
    const flagged = new Set(data.flags || []);

    // 1) set checkboxes
    document.querySelectorAll('.review-flag-input').forEach(cb => {
      const pid = cb.dataset.param;
      cb.checked = flagged.has(pid);
    });

    // 2) badge sui quadratini
    document.querySelectorAll('.param-btn').forEach(btn => {
      const pid = (btn.dataset.target || '').replace(/^p-/, '');
      const badge = btn.querySelector('.badge-review');
      if (!badge) return;
      if (flagged.has(pid)) {
        badge.hidden = false;
        badge.setAttribute('aria-label', 'Marked to review');
      } else {
        badge.hidden = true;
      }
    });
  } catch(e) { /* silenzioso */ }
})();

// B) Toggle salvataggio immediato (AJAX) quando spunti la checkbox
document.addEventListener('change', async function(e){
  const el = e.target;
  if (!el.classList || !el.classList.contains('review-flag-input')) return;
  const pid = el.dataset.param;
  const lang = el.dataset.lang;
  const flag = el.checked ? '1' : '0';

  try {
    const url = "{% url 'toggle_review_flag' 'LANG' 'PARAM' %}"
      .replace('LANG','__LANG__').replace('PARAM','__PARAM__')
      .replace('__LANG__', encodeURIComponent(lang))
      .replace('__PARAM__', encodeURIComponent(pid));
    const resp = await fetch(url, {
      method: 'POST',
      headers: { 'X-CSRFToken': csrftoken, 'Accept': 'application/json' },
      body: new URLSearchParams({ flag })
    });
    if (!resp.ok) throw new Error('Bad response');

    // Aggiorna badge immediatamente
    const btn = document.querySelector(`.param-btn[data-target="p-${pid}"] .badge-review`);
    if (btn) btn.hidden = (flag !== '1');
  } catch (err) {
    alert('Errore nel salvataggio del promemoria. Riprova.');
    // revert UI
    el.checked = !el.checked;
  }
});
</script>
{% endblock %}
