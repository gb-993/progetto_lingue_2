{% extends "base.html" %} 
{% load static %}
{% block title %}Language data{% endblock %}

{% block breadcrumb %}
  <li>
    <a href="{% url 'language_list' %}">Languages</a>
  </li>
  <li>
    {{ language.id }}
  </li>
  <li aria-current="page">Data</li>
{% endblock %}

{% block content %}
<main class="{% with s=lang_status.overall %}{% if not is_admin and s == 'waiting' or not is_admin and s == 'waiting_for_approval' or not is_admin and s == 'approved' or not is_admin and s == 'rejected' %}is-readonly{% endif %}{% endwith %}">
  <div class="card lang-header-card">
    <div class="lang-title-block">
      <h2>
        {{ language.name_full }}
        <span class="muted" style="font-weight:400; font-size: 0.7em; vertical-align: middle;">({{ language.id }})</span>
      </h2>
    </div>

    <div class="header-meta-grid">

      <div class="header-meta-row">
        <span class="meta-label">Glottocode</span>
        <span class="meta-value">{% if language.glottocode %}{{ language.glottocode }}{% else %}<span class="muted">—</span>{% endif %}</span>
      </div>

      <div class="header-meta-row">
        <span class="meta-label">ISO code</span>
        <span class="meta-value">{% if language.isocode %}{{ language.isocode }}{% else %}<span class="muted">—</span>{% endif %}</span>
      </div>

      <div class="header-meta-row">
        <span class="meta-label">Lat / Long</span>
        <span class="meta-value">
          {% if language.latitude %}{{ language.latitude }}{% else %}-{% endif %} /
          {% if language.longitude %}{{ language.longitude }}{% else %}-{% endif %}
        </span>
      </div>

      <div class="header-meta-row">
        <span class="meta-label">Historical</span>
        <span class="meta-value">
          {% if language.historical_language %}Yes{% else %}No{% endif %}
        </span>
      </div>

      {% if language.source %}
      <div class="header-meta-row" style="grid-column: 1 / -1;"> <span class="meta-label">Source</span>
        <span class="meta-value">{{ language.source }}</span>
      </div>
      {% endif %}

      <div class="header-meta-row">
        <span class="meta-label">Supervisor</span>
        <span class="meta-value">{% if language.supervisor %}{{ language.supervisor }}{% else %}<span class="muted">—</span>{% endif %}</span>
      </div>

      <div class="header-meta-row">
        <span class="meta-label">Informant</span>
        <span class="meta-value">{% if language.informant %}{{ language.informant }}{% else %}<span class="muted">—</span>{% endif %}</span>
      </div>

      {% if is_admin %}
      <div class="header-meta-row">
        <span class="meta-label">Assigned to</span>
        <span class="meta-value">
          {% if language.assigned_user %}
            {{ language.assigned_user.name }} {{ language.assigned_user.surname }}
          {% else %}
            <span class="muted">—</span>
          {% endif %}
        </span>
      </div>
      {% endif %}

    </div>
  </div>

   {# === Stato e azioni workflow === #}
  <div class="card workflow-card" style="margin-top:.5rem">

    <div class="workflow-status-block">
      <div class="workflow-status-line">
        <strong>Status:</strong>
        {% with s=lang_status.overall %}
          {% if s == "approved" %}
            <span class="badge b-ok">Approved</span>
          {% elif s == "waiting" or s == "waiting_for_approval" %}
            <span class="badge">Waiting for approval</span>
          {% elif s == "rejected" %}
            <span class="badge b-warn">Rejected</span>
          {% else %}
            <span class="badge b-warn">Pending</span>
          {% endif %}
        {% endwith %}
      </div>

      {% if last_reject %}
        {% with s=lang_status.overall %}
          {% if is_admin or s != 'approved' %}
            <div class="workflow-last-reject muted">
              <div class="last-reject-label">Last rejection:</div>
              <div class="last-reject-body">
                <div class="last-reject-meta">
                  {{ last_reject.created_at|date:"Y-m-d H:i" }}
                </div>
                <div class="last-reject-msg">
                  {% if last_reject.message %}
                    “{{ last_reject.message }}”
                  {% else %}
                    <em>no message provided</em>
                  {% endif %}
                </div>
              </div>
            </div>
          {% endif %}
        {% endwith %}
      {% endif %}
    </div>

{% if is_admin %}
  {# === AZIONI ADMIN: GRIGLIA A 3 COLONNE === #}
  <div class="workflow-action-grid grid-3-cols">

    <form method="post" class="workflow-form-block" action="{% url 'language_reject' language.id %}">
      {% csrf_token %}
      <div class="workflow-info-text">
        <strong>Reject:</strong> Marks the data as incorrect. The user will need to reopen the language to modify it.
      </div>
      <button type="submit" class="btn workflow-main-btn">Reject</button>

      <details class="note-details reject-details">
        <summary class="details-toggle-btn" role="button">➜ Add rejection note</summary>
        <div class="details-panel">
          <textarea name="message" rows="2" class="details-textarea" placeholder="Explain the reason for rejection..."></textarea>
        </div>
      </details>
    </form>

    <div class="workflow-form-block utility-block">
      <div class="workflow-info-text">
        <strong>Download:</strong> Generates an .xlsx file with all answers, glosses, and examples entered so far.
      </div>
      <a href="{% url 'language_export_xlsx' language.id %}" class="btn workflow-secondary-btn">
        Download .xlsx
      </a>
    </div>

    <div class="workflow-form-block utility-block">
      <div class="workflow-info-text">
        <strong>Debug & Approve:</strong> Inspects implicational-conditions and give access to the Approval button.
      </div>
      <a href="{% url 'language_debug' language.id %}" class="btn workflow-secondary-btn">
        Debug & Approve
      </a>
    </div>

  </div>
{% else %}
      <div class="workflow-action-grid">

        {# Colonna azione principale: Reopen / Submit / Submit disabilitato #}
        {% with s=lang_status.overall %}
          {% if s == 'rejected' %}
            <form method="post"
                  class="workflow-form-block"
                  action="{% url 'language_reopen' language.id %}">
              {% csrf_token %}
              <button type="submit"
                      class="btn btn--primary workflow-main-btn">
                Reopen
              </button>
              <span class="locked-hint">
                Language was rejected. Press “Reopen” to continue editing.
              </span>
            </form>

          {% elif s == 'pending' %}
            <form method="post"
                  class="workflow-form-block"
                  action="{% url 'language_submit' language.id %}">
              {% csrf_token %}
              <button type="submit"
                      class="btn btn--primary workflow-main-btn">
                Submit for review
              </button>
            </form>

          {% else %}
            <div class="workflow-form-block">
              <span class="hint-disabled"
                    title="{% if s == 'waiting_for_approval' or s == 'waiting' %}Waiting for admin's approval{% else %}Already approved{% endif %}"
                    tabindex="0">
                <button type="button"
                        class="btn workflow-main-btn"
                        disabled
                        aria-disabled="true">
                  Submit for review
                </button>
              </span>
            </div>
          {% endif %}
        {% endwith %}

        <div class="workflow-form-block">
          <a href="{% url 'language_export_xlsx' language.id %}"
             class="btn workflow-secondary-btn"
             data-role="download"
             title="Download .xlsx">
            Export .xlsx
          </a>
        </div>

      </div>
    {% endif %}

  </div>

    

  <!-- Barra di navigazione parametri -->
  <div class="param-nav" id="paramNav">
    {% for p in parameters %}
      <div
        class="param-btn"
        data-target="p-{{ p.id }}"
        data-status="{{ p.status }}"
        style="background:{{ p.bg_color }}; color:{{ p.fg_color }};"
        role="button"
        tabindex="0"
        title="Parameter {{ p.id }} — ..."
        aria-label="Parameter {{ p.id }}, ...">
        {{ p.id }} 
      </div>
    {% endfor %}
  </div>

  {% for p in parameters %}
    <section id="p-{{ p.id }}" class="param-section card">
      <h3 class="param-title">
        {{ p.id }} — {{ p.name }}

      </h3>

      {% if p.short_description %}
        <p class="muted">{{ p.short_description }}</p>
      {% endif %}

      <form method="post" action="{% url 'parameter_save' language.id p.id %}">
        {% csrf_token %}
        {% for q in p.questions.all %}
          <div class="card" style="margin-bottom:2rem">

          {# --- Testo domanda + help (inline) --- #}
          <div class="q-head">
              <div class="q-head__main">
                <strong class="q-id">{{ q.id }}</strong>
                <div class="q-text">{{ q.text }}</div>
              </div>

              {% if q.help_info %}
                <details class="help-info help-info--inline">
                  <summary class="help-info__summary" role="button" aria-expanded="false">
                    <span aria-hidden="true">❓</span> More info
                  </summary>
                  <div class="help-info__panel muted">{{ q.help_info|linebreaksbr }}</div>
                </details>
              {% endif %}
            </div>


            {% if q.instruction %}
              <div class="info-row muted">
                <div class="info-row__label">General instructions</div>
                <div class="info-row__content">{{ q.instruction|linebreaksbr }}</div>
              </div>
            {% endif %}

            {# data.html — NUOVA VERSIONE #}
            {% if q.example_yes %}
              <div class="info-row muted">
                <div class="info-row__label">Example YES</div>
                <div class="info-row__content">
                  <div class="example-yes-text" style="white-space: pre-wrap;">{{ q.example_yes }}</div>
                </div>
              </div>
            {% endif %}


            {# --- ANSWER SELECT + istruzioni dinamiche --- #}
            <div class="qa-fields">

              {# Questa è la riga della selezione allineata al resto del layout #}
              <div class="info-row" style="margin-bottom: 1rem;">
                <label class="info-row__label" for="resp_{{ q.id }}">Answer</label>
                <div class="info-row__content">
                  <select id="resp_{{ q.id }}" name="resp_{{ q.id }}" class="resp-select" data-qid="{{ q.id }}" style="max-width: 300px;">
                    <option value="" {% if q.ans.response_text == "" %}selected{% endif %}>— select —</option>
                    <option value="yes" {% if q.ans.response_text == "yes" %}selected{% endif %}>YES</option>
                    <option value="no"  {% if q.ans.response_text == "no"  %}selected{% endif %}>NO</option>
                  </select>
                </div>
              </div>

              {# Istruzioni per YES (già ottimizzate info-row) #}
              <div class="yes-instruction-block"
                   data-qid="{{ q.id }}"
                   {% if q.ans.response_text|lower != "yes" %}style="display:none"{% endif %}>
                <div class="info-row muted">
                  <div class="info-row__label">Instructions (YES)</div>
                  <div class="info-row__content">
                    {% if q.instruction_yes %}
                      {{ q.instruction_yes|linebreaksbr }}
                    {% else %}
                      not provided
                    {% endif %}
                  </div>
                </div>
              </div>

              {# Istruzioni per NO (già ottimizzate info-row) #}
              <div class="no-instruction-block"
                   data-qid="{{ q.id }}"
                   {% if q.ans.response_text|lower != "no" %}style="display:none"{% endif %}>
                <div class="info-row muted">
                  <div class="info-row__label">Instructions (NO)</div>
                  <div class="info-row__content">
                    {% if q.instruction_no %}
                      {{ q.instruction_no|linebreaksbr }}
                    {% else %}
                      not provided
                    {% endif %}
                  </div>
                </div>
              </div>

            </div>


            {# --- MOTIVATIONS (solo se risposta == NO) --- #}
            <div class="mot-block"
                 data-qid="{{ q.id }}"
                 {% if q.ans.response_text != "no" %}style="display:none"{% endif %}>
              <div class="muted" style="margin:.5rem 0 .25rem;">
                Select one or more motivations (if applicable).
              </div>

              <fieldset class="mot-checklist" aria-label="Motivations for NO" data-qid="{{ q.id }}">
                {% for m in q.allowed_motivations_list %}
                  <label class="checkbox-item" style="display:flex;gap:.5rem;align-items:flex-start;margin:.2rem 0;">
                    <input
                      type="checkbox"
                      name="mot_{{ q.id }}"
                      value="{{ m.id }}"
                      data-exclusive="{% if m.code == 'MOT1' %}1{% else %}0{% endif %}"
                      {% if m.id in q.ans.motivation_ids %}checked{% endif %}
                      {% with s=lang_status.overall %}
                        {% if not is_admin and s == 'waiting' or not is_admin and s == 'waiting_for_approval' or not is_admin and s == 'approved' or not is_admin and s == 'rejected' %}
                          disabled aria-disabled="true"
                        {% endif %}
                      {% endwith %}
                    >
                    <span>
                      <span><strong>{{ m.label|default:m.code }}</strong></span>
                    </span>
                  </label>
                {% empty %}
                  <div class="muted">No motivations configured for this question.</div>
                {% endfor %}
              </fieldset>
            </div>

            {# --- EXAMPLES BLOCK --- #}
            <div class="examples-block"
                 data-qid="{{ q.id }}"
                 data-template="{{ q.template_type|default:'linear' }}"
                 {% if q.ans.response_text == "" %}style="display:none"{% endif %}>

              <div class="info-row">
                {# Colonna Sinistra: Etichetta grigia #}
                <div class="info-row__label">Examples</div>

                {# Colonna Destra: Tutto il contenuto (Errori, Card, Bottone Add) #}
                <div class="info-row__content">

                  {# Spazio per errori JS #}
                  <div class="field-error js-yes-examples-error" data-qid="{{ q.id }}" aria-live="polite" style="display:none; margin-bottom: 1rem;"></div>

                  <div class="examples-list" data-qid="{{ q.id }}">
                    {% for ex in q.ans.examples %}
                      <div class="card example-row" style="margin-bottom: 1rem;">
                        <input type="hidden" name="ex_{{ ex.id }}_number" value="{{ ex.number }}">

                        <div class="grid">
                          {# 1. Example Text #}
                          <div>
                            <label>Example text</label>
                            <textarea name="ex_{{ ex.id }}_textarea" rows="3" style="width:100%; resize:vertical;">{{ ex.textarea }}</textarea>
                          </div>
                        
                          {# 2. Transliteration:  #}
                          <div>
                            <label>Transliteration</label>
                            <textarea name="ex_{{ ex.id }}_transliteration" rows="1" style="width:100%; resize:vertical;">{{ ex.transliteration }}</textarea>
                          </div>
                        
                          {# 3. Gloss:  #}
                          <div>
                            <label>Gloss</label>
                            <textarea name="ex_{{ ex.id }}_gloss" rows="1" style="width:100%; resize:vertical;">{{ ex.gloss }}</textarea>
                          </div>
                        
                          {# 4. English Translation:  #}
                          <div>
                            <label>English Translation</label>
                            <textarea name="ex_{{ ex.id }}_translation" rows="1" style="width:100%; resize:vertical;">{{ ex.translation }}</textarea>
                          </div>
                        
                          {# 5. Reference:  #}
                          <div>
                            <label>Reference</label>
                            <textarea name="ex_{{ ex.id }}_reference" rows="1" style="width:100%; resize:vertical;">{{ ex.reference }}</textarea>
                          </div>
                        </div>

                        <div class="toolbar" style="margin-top:.5rem; display: flex; justify-content: flex-end;">
                          <input type="hidden" name="del_ex_{{ ex.id }}" value="0">
                          <button class="btn btn-ex-toggle-delete"
                                  type="button"
                                  data-qid="{{ q.id }}"
                                  data-exid="{{ ex.id }}">Delete</button>
                        </div>
                      </div>
                    {% endfor %}
                  </div>

                  <div style="margin-top: 1rem;">
                    <button class="btn add-example-btn"
                            type="button"
                            data-qid="{{ q.id }}"
                            {% with s=lang_status.overall %}
                              {% if not is_admin and s == 'waiting' or not is_admin and s == 'waiting_for_approval' or not is_admin and s == 'approved' or not is_admin and s == 'rejected' %}
                                disabled aria-disabled="true" title="Editing locked until review"
                              {% endif %}
                            {% endwith %}>Add example</button>
                  </div>
                </div>
              </div>
            </div>

            {# --- COMMENTS  --- #}
            <div class="qa-fields comments-row" style="margin-top:1rem;">
              <label class="info-row__label" for="com_{{ q.id }}">Comments</label>
              <div class="info-row__content">
                <textarea id="com_{{ q.id }}" name="com_{{ q.id }}" style="width: 100%;" ...>{{ q.ans.comments }}</textarea>
              </div>
            </div>

          </div> 
        {% endfor %}

        <div class="toolbar sticky-parameter-toolbar" style="margin-top:.75rem; display:flex; flex-direction:column; gap:.75rem;">
          <!-- riga SAVE -->
          <div style="display:flex; align-items:center; gap:.75rem; flex-wrap:wrap; width:100%;">
            <p class="muted" style="margin:0; font-size:.9rem;">
                Click <strong style="color: var(--ok);">Save</strong> if you are <strong style="color: var(--ok);">confident</strong> in your answer.
              You can still edit or review it later.
            </p>
            <button type="submit"
                    class="btn btn--ok"
                    data-submit-action="save"
                    style="margin-left:auto;"
              {% with s=lang_status.overall %}
                {# CASO 1: Bottone Disabilitato (usa il title standard del browser) #}
                {% if not is_admin and s == 'waiting' or not is_admin and s == 'waiting_for_approval' or not is_admin and s == 'approved' or not is_admin and s == 'rejected' %}
                  disabled aria-disabled="true" title="Editing locked until review"

                {# CASO 2: Bottone Attivo (usa il nostro tooltip CSS istantaneo) #}
                {% else %}
                  data-tooltip="You can still change answer later"
                {% endif %}
              {% endwith %}>
              Confident -> Save {{ p.id }}
            </button>
          </div>

          <!-- riga NEXT -->
          <div style="display:flex; align-items:center; gap:.75rem; flex-wrap:wrap; width:100%;">
            <p class="muted" style="margin:0; font-size:.9rem;">
                Click <strong style="color: var(--bad);">Next</strong> if you are <strong style="color: var(--bad);">unsure</strong> in your answer.
                You can still edit or review it later.
            </p>
            <button type="submit"
                    class="btn btn--bad"
                    data-submit-action="next"
                    style="margin-left:auto;"
              {% with s=lang_status.overall %}
                {# CASO 1: Bottone Disabilitato #}
                {% if not is_admin and s == 'waiting' or not is_admin and s == 'waiting_for_approval' or not is_admin and s == 'approved' or not is_admin and s == 'rejected' %}
                  disabled aria-disabled="true" title="Editing locked until review"

                {# CASO 2: Bottone Attivo #}
                {% else %}
                  data-tooltip="You can still change answer later"
                {% endif %}
              {% endwith %}>
              Unsure -> Next
            </button>
          </div>

          <input type="hidden" name="action" value="save" data-action-field="1">
        </div>

      </form>
    </section>
  {% endfor %}
</main>
{% endblock %}


{% block extra_head %}
  <script src="{% static 'js/param_organize.js' %}"></script>
  <script src="{% static 'js/examples.js' %}"></script>
  <script src="{% static 'js/submission_create.js' %}"></script>
  <script src="{% static 'js/autosize_textarea.js' %}"></script>
  <script src="{% static 'js/instruction_yes.js' %}"></script>
  <script src="{% static 'js/instruction_no.js' %}"></script>


  <style>
/* ==========================================================================
   1. NAVIGAZIONE E STATI PARAMETRI (Invariato)
   ========================================================================== */
.param-nav { display: flex; flex-wrap: wrap; gap: .4rem; margin-bottom: 1rem; }
.param-btn {
  width: 2.4rem; height: 2.4rem; border-radius: 4px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; font-weight: bold; border: 2px solid rgba(0,0,0,.65);
  transition: transform .1s; position: relative;
  background-clip: padding-box;
}
.param-btn:hover { transform: scale(1.1); }
.param-section { display: none; }
.param-section.active { display: block; }

.param-nav .param-btn { border: 2px solid rgba(0,0,0,.65); border-radius: 6px; }
.param-nav .param-btn[data-status="ok"] { border-radius: 50%; }
.param-nav .param-btn[data-status="untouched"] { background: transparent !important; color: inherit !important; }

.param-btn .badge-review {
  position: absolute; top: -6px; left: -6px; width: 14px; height: 14px;
  border-radius: 50%; background: var(--bad, #b00020);
  border: 2px solid #fff; box-shadow: 0 0 0 1px rgba(0,0,0,.15); z-index: 2;
}
:root[data-theme="dark"] .param-btn .badge-review { border-color: var(--surface, #1e1f22); }

@media (min-width: 1200px) {
  .param-btn .badge-review { width: 16px; height: 16px; top: -7px; left: -7px; }
}
.badge-review[hidden] { display: none !important; }

/* ==========================================================================
   2. CAMPI DOMANDE E MODALITÀ READ-ONLY (Invariato)
   ========================================================================== */
.qa-fields { display: flex; flex-direction: column; gap: .75rem; }
textarea.auto-grow { width: 100%; min-height: 2.5rem; max-height: 40vh; overflow: hidden; resize: vertical; }
textarea.auto-grow:focus { outline: 2px solid var(--focus, #2266ff); outline-offset: 2px; }


/* --- EVIDENZIAZIONE FUNZIONALE: LAYOUT A CAPO  --- */

/* --- EVIDENZIAZIONE FUNZIONALE: LAYOUT A CAPO (A + C) --- */

/* 1. Container con barra rossa laterale */
.q-head {
  display: grid;
  grid-template-columns: 1fr auto;
  column-gap: 1rem;
  align-items: start;
  border-left: 3px solid var(--brand);
  padding-left: 0.85rem;
  margin-bottom: 1rem;
}

/* Forza ID e Testo uno sopra l'altro */
.q-head__main {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

/*  Label della domanda (ID) in rosso brand */
.q-id {
  color: var(--brand);
  font-weight: 700;
  font-size: 1.1rem;
  line-height: 1.2;
  display: block;
}

/* Testo della domanda */
.q-text {
  font-weight: 600;
  font-size: 1.05rem;
  line-height: 1.4;
  color: var(--text);
}

/* Pannello "More info" */
.help-info__panel {
  grid-column: 1 / -1;
  margin-top: 0.5rem;
}

.q-head__text strong {
  color: var(--brand);                 /* Testo rosso/arancio brand */
  font-weight: 700;
  background: none;                    /* Rimuove lo sfondo grigio di prima */
  border: none;                        /* Rimuove il bordo del badge */
  padding: 0;                          /* Rimuove il padding interno */
  font-family: var(--ff);              /* Torna al font standard, più sobrio */
}

.is-readonly .card input, .is-readonly .card select, .is-readonly .card textarea {
  background: var(--surface-2, #f1f3f5); color: var(--muted-fg, #666);
  border-color: var(--border, #d0d7de); pointer-events: none;
}
.is-readonly .btn, .is-readonly .add-example-btn, .is-readonly .btn-ex-toggle-delete {
  opacity: .55; cursor: not-allowed; pointer-events: none;
}
.is-readonly form[action$="reopen/"] .btn, .is-readonly a.btn[data-role="download"] {
  opacity: 1; pointer-events: auto; cursor: pointer;
}

/* ==========================================================================
   3. WORKFLOW: STATO E ULTIMO RIFIUTO
   ========================================================================== */
.workflow-status-block { margin-bottom: 1rem; font-size: .9rem; line-height: 1.4; }
.workflow-status-line { display: flex; flex-wrap: wrap; gap: .5rem; align-items: center; font-size: 1rem; font-weight: 500; }

.workflow-last-reject {
  margin-top: .5rem; padding: .5rem .75rem; border-left: 3px solid var(--bad, #b00020);
  background: var(--surface-2, rgba(0,0,0,0.03)); border-radius: 4px;
}
:root[data-theme="dark"] .workflow-last-reject { background: rgba(255,255,255,0.05); }

.workflow-last-reject .last-reject-label { font-weight: 600; margin-bottom: .25rem; color: var(--fg, #222); }
:root[data-theme="dark"] .workflow-last-reject .last-reject-label { color: #fff; }

/* ==========================================================================
   4. WORKFLOW: GRIGLIA AZIONI (ADMIN & USER)
   ========================================================================== */
.workflow-action-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(min(18rem, 100%), 1fr));
  gap: 1.5rem;
  width: 100%;
  margin: 0 auto;
}

/* Forza 3 colonne fisse per Admin su schermi grandi */
.grid-3-cols {
  grid-template-columns: repeat(3, 1fr) !important;
  max-width: 100% !important;
}

.workflow-form-block {
  display: flex; flex-direction: column; align-items: stretch; gap: .5rem;
  padding: 0.75rem 1rem; border-radius: 4px; border: 1px solid var(--border);
  background: var(--surface-2); box-shadow: 0 1px 2px rgba(0,0,0,.06);
}

/* Testi informativi sopra i pulsanti */
.workflow-info-text { font-size: 0.85rem; line-height: 1.3; margin-bottom: 0.75rem; min-height: 3rem; }
.workflow-info-text strong { display: block; margin-bottom: 0.2rem; color: var(--fg, #222); }

/* Correzione contrasto Dark Mode per Admin Actions */
:root[data-theme="dark"] .workflow-info-text strong { color: #ffffff !important; }
:root[data-theme="dark"] .workflow-info-text { color: #adb5bd !important; }

/* Blocchi Utility (Export/Debug) */
.utility-block { border-style: dashed; opacity: 0.9; }
:root[data-theme="dark"] .utility-block { border-color: rgba(255,255,255,0.2); background: rgba(255,255,255,0.03); }

/* ==========================================================================
   5. PULSANTI E RESPONSIVITÀ
   ========================================================================== */
.workflow-main-btn, .workflow-secondary-btn {
  width: 100%; text-align: center; min-height: 2.4rem;
  justify-content: center; display: flex; align-items: center;
}
.btn--ok { --btn-bg: var(--ok); --btn-fg: #fff; }
.btn--bad { --btn-bg: var(--bad); --btn-fg: #fff; }

@media (max-width: 900px) {
  .grid-3-cols { grid-template-columns: 1fr !important; }
  .workflow-info-text { min-height: auto; }
}

/* ==========================================================================
   6. STILE PER IL TASTO "ADD NOTE" (Espandibile)
   ========================================================================== */
.details-toggle-btn {
  list-style: none;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.85rem;
  font-weight: 600;

  /* Aspetto da pulsante secondario */
  padding: 0.4rem 0.75rem;
  margin-top: 0.25rem;
  border-radius: 6px;
  border: 1px solid var(--border, #d0d7de);
  background: var(--surface-2, #f1f3f5);
  color: var(--fg, #222);

  transition: all 0.2s ease;
  user-select: none;
}

/* Effetto al passaggio del mouse */
.details-toggle-btn:hover {
  background: var(--border, #d0d7de);
  border-color: var(--muted-fg, #666);
}

/* Fix per Tema Scuro */
:root[data-theme="dark"] .details-toggle-btn {
  background: rgba(255, 255, 255, 0.05);
  color: #fff;
  border-color: rgba(255, 255, 255, 0.2);
}

:root[data-theme="dark"] .details-toggle-btn:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(255, 255, 255, 0.4);
}

/* Rimuove la freccetta predefinita del browser */
.details-toggle-btn::-webkit-details-marker {
  display: none;
}

/* ==========================================================================
   7. TOOLBAR FLOATING (SAVE/NEXT) - Glass Effect
   ========================================================================== */
.sticky-parameter-toolbar {
  position: sticky;
  bottom: 1rem; /* La stacca dal fondo per farla sembrare sospesa */
  z-index: 100;

  /* Layout e Spazi */
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
  padding: 1rem 1.25rem;
  margin: 1.5rem 0 0.5rem 0;

  /* Arrotondamento coerente con --radius (12px) */
  border-radius: var(--radius, 12px);
  border: 1px solid var(--border, #dadde2);

  /* Effetto Trasparenza e Vetro (Backdrop Filter) */
  background: rgba(255, 255, 255, 0.6); /* Bianco semi-trasparente quarto valore per trasparenza + basso = + trasparente */
  backdrop-filter: blur(8px); /* Sfoca quello che passa sotto + basso = + nitido sotto*/
  -webkit-backdrop-filter: blur(10px);

  box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
}

/* Fix Tema Scuro per Effetto Vetro */
:root[data-theme="dark"] .sticky-parameter-toolbar {
  background: rgba(21, 23, 27, 0.6); /* Usa --surface semi-trasparente */
  border-color: rgba(255, 255, 255, 0.1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
}

/* Ottimizzazione pulsanti interni per la barra floating */
.sticky-parameter-toolbar .btn {
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

/* Responsività */
@media (max-width: 600px) {
  .sticky-parameter-toolbar {
    bottom: 0.5rem;
    padding: 0.75rem 1rem;
    margin: 1rem 0 0 0;
  }
}

/* ==========================================================================
   8. LAYOUT PARAMETRI E NESTING DELLE CARD
   ========================================================================== */
/* Il contenitore principale del parametro  */
.param-section.card {
  background-color: var(--surface-2) !important;
  border: 1px solid var(--border);
  padding: 1.5rem; /* Aumenta lo spazio interno del contenitore */
  margin-bottom: 2.5rem; /* Distanzia maggiormente i parametri tra loro */
}

/* Le card delle singole domande all'interno del parametro tornano al colore
   standard (più scuro) per creare contrasto e "staccare" dal fondo */
.param-section .card {
  background-color: var(--surface);
  border: 1px solid var(--border);
  box-shadow: var(--shadow);
  margin-bottom: 1.5rem; /* Spazio costante tra le domande */
}

/* Rende il titolo del parametro più evidente sopra il nuovo sfondo */
.param-title {
  margin-bottom: 1.25rem;
  padding-bottom: 0.5rem;
  border-bottom: 1px solid var(--border);
}

/* ==========================================================================
   9. LAYOUT INFORMAZIONI ORIZZONTALI (Forzatura 25% / 75%)
   ========================================================================== */
.info-row, .language-meta-grid, .comments-row {
  display: grid !important;
  /* 25% alle etichette, il resto (75%) al contenuto */
  grid-template-columns: 25% 1fr !important;
  gap: 1.5rem;
  margin: 0.75rem 0;
  align-items: start;
}

.info-row__label,
.language-meta-grid dt,
.label-style {
  font-weight: 900 !important;
  text-transform: uppercase !important;
  font-size: 0.8rem !important; /* Leggermente più piccolo per evitare a capo */
  letter-spacing: 0.05em !important;
  color: var(--muted-fg, #444) !important;
  padding-top: 0.15rem;
  margin: 0;
  /* Permette alle parole lunghe di andare a capo se necessario
     senza allargare la colonna del 25% */
  word-wrap: break-word;
  white-space: normal;
}

.info-row__content, .language-meta-grid dd {
  font-size: 0.95rem;
  line-height: 1.5;
  margin: 0;
}

@media (max-width: 950px) {
  .info-row, .language-meta-grid, .comments-row {
    grid-template-columns: 1fr;
    gap: 0.25rem;
  }
}


/* --- Stile Intestazione Lingua --- */
.lang-header-card {
  padding: 1.5rem 2rem;
}

.lang-title-block h2 {
  margin: 0 0 1.5rem 0; /* Spazio sotto il titolo */
  font-size: 1.8rem;
  color: var(--brand); /* Opzionale: usa il colore brand per il titolo */
}

/* Griglia Principale: Distribuisce gli elementi su colonne larghe */
.header-meta-grid {
  display: grid;
  /* Crea colonne automatiche larghe almeno 350px, riempiendo lo spazio disponibile */
  grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
  column-gap: 4rem; /* Molto spazio orizzontale tra le colonne per dare "respiro" */
  row-gap: 0.8rem;  /* Spazio verticale ridotto */
  align-items: start;
}

/* Singola Riga: Etichetta a Sinistra, Valore a Destra */
.header-meta-row {
  display: grid;
  /* Colonna 1 fissa (etichetta), Colonna 2 flessibile (valore) */
  grid-template-columns: 140px 1fr;
  align-items: baseline;
  gap: 1rem;
  border-bottom: 1px solid transparent; /* Per debug/allineamento */
}

/* Stile Etichetta (Simile ai Parametri) */
.meta-label {
  font-size: 0.75rem;
  font-weight: 800;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--text-muted);
  text-align: right; /* Allinea l'etichetta vicino al valore */
}

/* Stile Valore */
.meta-value {
  font-size: 1rem;
  font-weight: 500;
  color: var(--text);
  line-height: 1.4;
}

/* Mobile: Torna a una colonna singola */
@media (max-width: 768px) {
  .header-meta-grid {
    grid-template-columns: 1fr;
    gap: 1rem;
  }
  .header-meta-row {
    grid-template-columns: 100px 1fr; /* Etichetta più stretta su mobile */
  }
  .meta-label {
    text-align: left; /* Su mobile meglio allineato a sinistra */
  }
}

/* Stile per il tooltip personalizzato sui bottoni */
.btn[data-tooltip] {
  position: relative; /* Necessario per posizionare il fumetto */
}

/* Il fumetto che appare all'hover */
.btn[data-tooltip]:hover::after {
  content: attr(data-tooltip); /* Prende il testo dall'attributo HTML */
  position: absolute;
  bottom: 110%; /* Lo posiziona sopra il bottone */
  left: 50%;
  transform: translateX(-50%); /* Lo centra perfettamente */

  background-color: #333;
  color: #fff;
  padding: 0.4rem 0.8rem;
  border-radius: 4px;
  font-size: 0.8rem;
  white-space: nowrap; /* Evita che il testo vada a capo */
  z-index: 1000;
  pointer-events: none; /* Il mouse non ci sbatte contro */
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);

  /* Animazione facoltativa */
  opacity: 0;
  animation: fadeInTooltip 0.2s forwards;
}

/* Piccola freccetta sotto il fumetto (opzionale) */
.btn[data-tooltip]:hover::before {
  content: '';
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  border-width: 5px;
  border-style: solid;
  border-color: #333 transparent transparent transparent;
  opacity: 0;
  animation: fadeInTooltip 0.2s forwards;
}

@keyframes fadeInTooltip {
  to { opacity: 1; }
}


</style>
{% endblock %}





{% block extra_js %}
<script>
// CSRF
function getCookie(name) {
  const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
  return m ? m.pop() : '';
}
const csrftoken = getCookie('csrftoken');

document.querySelectorAll('.badge-review').forEach(b => b.hidden = true);

// A) Fetch dei flag per l'utente corrente su questa lingua
(async function initReviewFlags(){
  try {
    const url = "{% url 'review_flags_list' language.id %}";
    const resp = await fetch(url, { headers: { 'Accept': 'application/json' }});
    if (!resp.ok) return;
    const data = await resp.json();  
    const flagged = new Set(data.flags || []);

    // 1) set checkboxes
    document.querySelectorAll('.review-flag-input').forEach(cb => {
      const pid = cb.dataset.param;
      cb.checked = flagged.has(pid);
    });

    // 2) badge sui quadratini
    document.querySelectorAll('.param-btn').forEach(btn => {
      const pid = (btn.dataset.target || '').replace(/^p-/, '');
      const badge = btn.querySelector('.badge-review');
      if (!badge) return;
      if (flagged.has(pid)) {
        badge.hidden = false;
        badge.setAttribute('aria-label', 'Marked to review');
      } else {
        badge.hidden = true;
      }
    });
  } catch(e) { /* silenzioso */ }
})();

// Da togliere??
// B) Toggle salvataggio immediato (AJAX) quando spunti la checkbox
document.addEventListener('change', async function(e){
  const el = e.target;
  if (!el.classList || !el.classList.contains('review-flag-input')) return;
  const pid = el.dataset.param;
  const lang = el.dataset.lang;
  const flag = el.checked ? '1' : '0';

  try {
    const url = "{% url 'toggle_review_flag' 'LANG' 'PARAM' %}"
      .replace('LANG','__LANG__').replace('PARAM','__PARAM__')
      .replace('__LANG__', encodeURIComponent(lang))
      .replace('__PARAM__', encodeURIComponent(pid));
    const resp = await fetch(url, {
      method: 'POST',
      headers: { 'X-CSRFToken': csrftoken, 'Accept': 'application/json' },
      body: new URLSearchParams({ flag })
    });
    if (!resp.ok) throw new Error('Bad response');

    // Aggiorna badge immediatamente
    const btn = document.querySelector(`.param-btn[data-target="p-${pid}"] .badge-review`);
    if (btn) btn.hidden = (flag !== '1');
  } catch (err) {
    alert('Errore nel salvataggio del promemoria. Riprova.');
    el.checked = !el.checked;
  }
});
</script>

<script>
// Imposta il campo hidden "action" in base al bottone premuto (save/next)
document.addEventListener('click', function(e){
  const btn = e.target.closest('button[data-submit-action]');
  if (!btn) return;
  const form = btn.closest('form');
  if (!form) return;
  const hidden = form.querySelector('input[data-action-field]');
  if (!hidden) return;
  hidden.value = btn.getAttribute('data-submit-action'); // "save" | "next"
});
</script>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const hash = window.location.hash;
  if (hash) {
    const targetId = hash.substring(1);

    // Cerca il bottone della nav che punta a questo ID
    const btn = document.querySelector(`.param-btn[data-target="${targetId}"]`);

    if (btn) {
      btn.click();
        setTimeout(() => {
        const section = document.getElementById(targetId);
        if (section) {
          section.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }, 100);
    }
  }
});
</script>
{% endblock %}
