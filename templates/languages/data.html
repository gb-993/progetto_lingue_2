{% extends "base.html" %}
{% load static %}

{% block title %}Language data{% endblock %}
{% block breadcrumb %}Languages / {{ language.id }} / Data{% endblock %}

{% block content %}
<main class="{% with s=lang_status.overall %}{% if not is_admin and s == 'waiting' or not is_admin and s == 'waiting_for_approval' or not is_admin and s == 'approved' or not is_admin and s == 'rejected' %}is-readonly{% endif %}{% endwith %}">
  <div class="card">
    <h2>{{ language.name_full }} ({{ language.id }})</h2>
    <p class="muted">Compila o modifica le risposte. Ogni pulsante “Save” salva solo il parametro aperto.</p>
  </div>
    {# === Stato e azioni workflow === #}
  <div class="card" style="margin-top:.5rem">
    <div class="grid grid-2">
      <div>
        <strong>Status:</strong>
        {% with s=lang_status.overall %}
          {% if s == "approved" %}
            <span class="badge b-ok">Approved</span>
          {% elif s == "waiting" or s == "waiting_for_approval" %}
            <span class="badge">Waiting for approval</span>
          {% elif s == "rejected" %}
            <span class="badge b-warn">Rejected</span>
          {% else %}
            <span class="badge b-warn">Pending</span>
          {% endif %}
        {% endwith %}

        {% if last_reject %}
          {% with s=lang_status.overall %}
            {% if is_admin or s != 'approved' %}
              <div class="muted" style="margin-top:.25rem">
                Ultimo rifiuto: {{ last_reject.created_at|date:"Y-m-d H:i" }} —
                {% if last_reject.message %}“{{ last_reject.message }}”{% else %}<em>nessun messaggio</em>{% endif %}
              </div>
            {% endif %}
          {% endwith %}
        {% endif %}

      </div>

      <div class="toolbar" style="justify-content:flex-end; gap:.5rem; flex-wrap:wrap">
        {# ====== Azioni per ADMIN ====== #}
        {% if is_admin %}

          {# --- CREA NUOVA SUBMISSION: POST alla view submission_create_for_language --- #}
          <form id="submission-create-form"
                method="post"
                action="{% url 'submission_create_for_language' language.id %}"
                {# questi data-* li usa lo script esterno, niente logica inline #}
                {% if not all_answered %}data-confirm-missing="1"{% endif %}
                data-confirm-message="Attenzione: ci sono risposte mancanti. Vuoi creare comunque la submission?"
                style="display:flex; gap:.5rem; align-items:flex-start; flex-wrap:wrap">
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ request.get_full_path }}">

            <button type="submit"
                    class="btn"
                    data-once="true"
                    title="Crea una nuova submission con lo stato attuale della lingua">
              Crea submission
            </button>

            <details>
              <summary>Aggiungi nota</summary>
              <div style="margin-top:.25rem; max-width:100%">
                <label for="note_{{ language.id }}" class="sr-only">Nota per la submission</label>
                <textarea id="note_{{ language.id }}" name="note" rows="2" style="min-width:18rem; max-width:100%"></textarea>
              </div>
            </details>
          </form>



          {# --- REJECT: bottone sopra, nota dopo (allineato in alto) --- #}
          <form method="post" action="{% url 'language_reject' language.id %}"
                style="display:flex; gap:.5rem; align-items:flex-start; flex-wrap:wrap">
            {% csrf_token %}
            <button type="submit" class="btn">Reject</button>
            <details>
              <summary>Aggiungi nota</summary>
              <div style="margin-top:.25rem">
                <label for="reject_message_{{ language.id }}" class="sr-only">Nota per il rifiuto</label>
                <textarea id="reject_message_{{ language.id }}" name="message" rows="2" style="min-width:18rem"></textarea>
              </div>
            </details>
          </form>

          {# --- APPROVE & RUN DAG --- #}
          <form method="post" action="{% url 'language_approve' language.id %}">
            {% csrf_token %}
            {% if not all_answered %}
              <span class="hint-disabled" title="Impossibile approvare finché mancano risposte" tabindex="0">
                <button type="submit" class="btn btn--primary" disabled aria-disabled="true">
                  Approve &amp; Run DAG
                </button>
              </span>
            {% else %}
              <button type="submit" class="btn btn--primary">
                Approve &amp; Run DAG
              </button>
            {% endif %}
          </form>

        {% endif %}


      </div>
    </div>
  </div>

  <!-- Barra di navigazione parametri -->
  <div class="param-nav" id="paramNav">
    {% for p in parameters %}
      <div class="param-btn"
           data-target="p-{{ p.id }}"
           style="background:{{ p.bg_color }}; color:{{ p.fg_color }}">
        {{ p.id }}
      </div>
    {% endfor %}
  </div>

  <!-- Sezioni parametri -->
  {% for p in parameters %}
  <section id="p-{{ p.id }}" class="param-section card">
    <h3>{{ p.id }} — {{ p.name }}</h3>
    {% if p.short_description %}
      <p class="muted">{{ p.short_description }}</p>
    {% endif %}

    <form method="post" action="{% url 'parameter_save' language.id p.id %}">
      {% csrf_token %}
      {% for q in p.questions.all %}
        <div class="card" style="margin-bottom:.5rem">
          <p><strong>{{ q.id }}</strong> — {{ q.text }}</p>
          {% if q.instruction %}<p class="muted">{{ q.instruction }}</p>{% endif %}

          <div class="grid grid-3">
            <div>
              <label for="resp_{{ q.id }}">Answer</label>
              <select id="resp_{{ q.id }}" name="resp_{{ q.id }}" class="resp-select" data-qid="{{ q.id }}">
                <option value="" {% if q.ans.response_text == "" %}selected{% endif %}>— seleziona —</option>
                <option value="yes" {% if q.ans.response_text == "yes" %}selected{% endif %}>YES</option>
                <option value="no" {% if q.ans.response_text == "no" %}selected{% endif %}>NO</option>
              </select>
            </div>

            <div>
              <label for="com_{{ q.id }}">Comments</label>
              <input id="com_{{ q.id }}" name="com_{{ q.id }}" value="{{ q.ans.comments }}">
            </div>

            <div class="mot-block" data-qid="{{ q.id }}"
                 {% if q.ans.response_text != "no" %}style="display:none"{% endif %}>
              <label for="mot_{{ q.id }}">Motivations (if NO)</label>
              <select id="mot_{{ q.id }}" name="mot_{{ q.id }}" multiple size="4">
                {% for m in q.allowed_motivations_list %}
                  <option value="{{ m.id }}" {% if m.id in q.ans.motivation_ids %}selected{% endif %}>{{ m.label }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="examples-block" data-qid="{{ q.id }}"
               {% if q.ans.response_text != "yes" %}style="display:none"{% endif %}>
            <div class="toolbar" style="margin:.5rem 0">
              <strong>Examples</strong>
              <button class="btn add-example-btn" type="button" data-qid="{{ q.id }}"
                {% with s=lang_status.overall %}
                  {% if not is_admin and s == 'waiting' or not is_admin and s == 'waiting_for_approval' or not is_admin and s == 'approved' or not is_admin and s == 'rejected'  %}
                    disabled aria-disabled="true" title="Editing bloccato fino alla revisione"
                  {% endif %}
                {% endwith %}
              >Add example</button>

            </div>

            <div class="examples-list" data-qid="{{ q.id }}">
              {% for ex in q.ans.examples %}
              <div class="card example-row" style="margin-bottom:.5rem">
                <div class="grid">
                  <div><label>Number</label><input name="ex_{{ ex.id }}_number" value="{{ ex.number }}"></div>
                  <div><label>Data</label><input name="ex_{{ ex.id }}_textarea" value="{{ ex.textarea }}"></div>
                  <div><label>Transliteration</label><input name="ex_{{ ex.id }}_transliteration" value="{{ ex.transliteration }}"></div>
                  <div><label>Gloss</label><input name="ex_{{ ex.id }}_gloss" value="{{ ex.gloss }}"></div>
                  <div><label>Translation</label><input name="ex_{{ ex.id }}_translation" value="{{ ex.translation }}"></div>
                  <div><label>Reference</label><input name="ex_{{ ex.id }}_reference" value="{{ ex.reference }}"></div>
                </div>
                <div class="toolbar" style="margin-top:.25rem">
                  <input type="hidden" name="del_ex_{{ ex.id }}" value="0">
                  <button class="btn btn-ex-toggle-delete" type="button" data-exid="{{ ex.id }}"
                    {% with s=lang_status.overall %}
                      {% if not is_admin and s == 'waiting' or not is_admin and s == 'waiting_for_approval' or not is_admin and s == 'approved' or not is_admin and s == 'rejected'  %}
                        disabled aria-disabled="true" title="Editing bloccato fino alla revisione"
                      {% endif %}
                    {% endwith %}
                  >Delete</button>
                </div>
              </div>
              {% empty %}
              <div class="muted">No examples yet</div>
              {% endfor %}
            </div>
          </div>
        </div>
      {% endfor %}

      <div class="toolbar" style="margin-top:.5rem">
        <button type="submit" class="btn btn--primary"
          {% with s=lang_status.overall %}
            {% if not is_admin and s == 'waiting' or not is_admin and s == 'waiting_for_approval' or not is_admin and s == 'approved' or not is_admin and s == 'rejected' %}
              disabled aria-disabled="true" title="Editing bloccato fino alla revisione"
            {% endif %}
          {% endwith %}
        >Save {{ p.id }}</button>
      </div>
    </form>
  </section>
  {% endfor %}
</main>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const navBtns = document.querySelectorAll('.param-btn');
  const sections = document.querySelectorAll('.param-section');

  function activate(id){
    sections.forEach(s=>s.classList.remove('active'));
    const tgt = document.getElementById(id);
    if(tgt){tgt.classList.add('active'); window.scrollTo({top:tgt.offsetTop-80,behavior:'smooth'});}
  }

  // Click sui quadratini
  navBtns.forEach(b=>{
    b.addEventListener('click',()=>{
      const target = b.dataset.target;
      // aggiorno l'hash così il back/forward del browser resta coerente
      location.hash = '#' + target;
      activate(target);
    });
  });

  // All’avvio: se c’è un hash (#p-XYZ) attiva quello, altrimenti il primo
  const hash = window.location.hash;
  const idFromHash = hash && hash.startsWith('#') ? hash.substring(1) : '';
  if (idFromHash && document.getElementById(idFromHash)) {
    activate(idFromHash);
  } else if (navBtns[0]) {
    activate(navBtns[0].dataset.target);
  }

  // Toggle motivazioni/esempi in base al valore YES/NO
  document.querySelectorAll('.resp-select').forEach(sel=>{
    sel.addEventListener('change',()=>{
      const qid=sel.dataset.qid;
      const mot=document.querySelector(`.mot-block[data-qid='${qid}']`);
      const exb=document.querySelector(`.examples-block[data-qid='${qid}']`);
      if(sel.value==='no'){mot.style.display='block';exb.style.display='none';}
      else if(sel.value==='yes'){mot.style.display='none';exb.style.display='block';}
      else{mot.style.display='none';exb.style.display='none';}
    });
  });
});
</script>

{% endblock %}

{% block extra_head %}
  <script src="{% static 'js/examples.js' %}"></script>
  <script src="{% static 'js/submission_create.js' %}"></script>
  <script src="{% static 'js/examples.js' %}"></script>
  <style>
    .param-nav {display:flex; flex-wrap:wrap; gap:.4rem; margin-bottom:1rem;}
    .param-btn {
      width:2.4rem; height:2.4rem; border-radius:4px;
      display:flex; align-items:center; justify-content:center;
      cursor:pointer; font-weight:bold; border:1px solid var(--border);
      transition:transform .1s;
    }
    .param-btn:hover {transform:scale(1.1);}
    .param-section {display:none;}
    .param-section.active {display:block;}

    /* === BLOCCO VISIVO (solo grafico) === */
    .is-readonly .card input,
    .is-readonly .card select,
    .is-readonly .card textarea {
      background: var(--surface-2, #f1f3f5);
      color: var(--muted-fg, #666);
      border-color: var(--border, #d0d7de);
      pointer-events: none;      /* niente click */
    }
    .is-readonly .card input::placeholder,
    .is-readonly .card textarea::placeholder { color: #999; }

    .is-readonly .btn,
    .is-readonly .add-example-btn,
    .is-readonly .btn-ex-toggle-delete {
      opacity: .55;
      cursor: not-allowed;
      pointer-events: none;      /* niente click */
    }

    /* Etichetta “Locked” discreta */
    .locked-hint {
      font-size: .9rem; color: #666;
      margin-left: .5rem;
    }

    .hint-disabled[title] { cursor: help; display: inline-block; }

    .is-readonly form[action$="reopen/"] .btn {
  opacity: 1;
  pointer-events: auto;
  cursor: pointer;
}
  </style>
{% endblock %}

