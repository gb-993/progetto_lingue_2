{% extends "base.html" %}
{% load static %}
{% block body_class %}page-graph{% endblock %}
{% block title %}Parameters DAG{% endblock %}
{% block breadcrumb %}Graphs / Parameters{% endblock %}

{% block extra_head %}
  <script defer src="{% static 'vendor/cytoscape.min.js' %}"></script>
  <script defer src="{% static 'js/param_graph.js' %}"></script>
  <script defer src="{% static 'js/param_lang_views.js' %}"></script>

  <style>
    .page-graph .legend .badge {
      border-radius: 999px;
      padding: 0.15rem 0.5rem;
      font-size: 0.85rem;
      border: 1px solid transparent;
    }

    /* valori parametrici */
    .page-graph .badge.b-plus {
      background-color: #1B5E20;
      color: #FFFFFF;
      border-color: #0B3D13;
    }
    .page-graph .badge.b-minus {
      background-color: #B71C1C;
      color: #FFFFFF;
      border-color: #7F0000;
    }
    .page-graph .badge.b-zero {
      background-color: #0D47A1;
      color: #FFFFFF;
      border-color: #002171;
    }
    .page-graph .badge.b-unset {
      background-color: #FAFAFA;
      color: #000000;
      border-color: #BDBDBD;
    }

    /* (quando nessuna lingua è selezionata) */
    .page-graph .badge.b-focus {
      background-color: #FFEB3B;
      color: #000000;
      border-color: #F57F17;
    }
    .page-graph .badge.b-up {
      background-color: #4CAF50;
      color: #FFFFFF;
      border-color: #1B5E20;
    }
    .page-graph .badge.b-down {
      background-color: #FF9800;
      color: #FFFFFF;
      border-color: #EF6C00;
    }
  </style>
{% endblock %}


{% block content %}
<header class="dashboard-hero">
  <h1>Graph</h1>
</header>

<section class="card" style="padding:1rem;">
  <div class="toolbar" style="display:flex; gap:.75rem; align-items:center; flex-wrap:wrap;">
    <label for="lang-select" class="visually-hidden">Language</label>
    <select id="lang-select" name="lang" style="min-width:14rem;">
      <option value="">No language selected</option>
      {% for l in languages %}
        <option value="{{ l.id }}" {% if preselect and preselect == l.id|stringformat:"s" %}selected{% endif %}>
          {{ l.id }} — {{ l.name_full }}
        </option>
      {% endfor %}
    </select>
    <button id="reloadBtn" class="btn btn--secondary" type="button">Reload</button>

    <div class="legend" aria-hidden="true">
      {# colori per valori parametri (usati anche nel grafo) #}
      <span class="badge b-plus">+</span>
      <span class="badge b-minus">–</span>
      <span class="badge b-zero">0</span>
      <span class="badge b-unset">unset</span>
      <span class="sep"></span>
      {# legenda implicazioni: valida solo quando nessuna lingua è selezionata #}
      <span class="badge b-focus">selected</span>
      <span class="badge b-up">implicants</span>
      <span class="badge b-down">implicated</span>
    </div>
  </div>

  <div id="graph-mode"
       class="graph-layout"
       {# NEW: graph sempre visibile, niente hidden in base a preselect #}
       style="display:flex; flex-direction:column; gap:.75rem;">

    <!-- Grafo -->
    <div id="cy-container"
         aria-label="Parameters graph"
         role="application"
         style="width:100%;
                height:640px;
                min-height:420px;
                border:1px solid var(--border,#ddd);
                border-radius:8px;
                background:var(--surface,#fff);
                position:relative;
                overflow:hidden;">
    </div>

<!-- Box Selection -->
    <aside class="graph-recap"
           aria-live="polite"
           style="border:1px solid var(--border,#ddd);
                  border-radius:8px;
                  padding:.75rem;
                  background:var(--surface-2,var(--surface,#fff));
                  width:100%;
                  align-self:stretch;
                  margin-top:.25rem;">
      <h3 style="margin:0 0 .5rem;">Selection</h3>

      <div style="margin-bottom:.5rem;">
        <strong>Parameter:</strong> <span id="recap-name">None</span>
      </div>

      <div style="margin-bottom:.5rem; display:flex; flex-wrap:wrap; gap:2rem; align-items:flex-start;">
        <div style="min-width:12rem; flex:1 1 0;">
          <h4 style="margin:.5rem 0 .25rem; font-size:.95rem;">Implicants (inputs)</h4>
          <ul id="recap-up" style="margin:0; padding-left:1rem;"></ul>
        </div>
        <div style="min-width:12rem; flex:1 1 0;">
          <h4 style="margin:.5rem 0 .25rem; font-size:.95rem;">Implicated (outputs)</h4>
          <ul id="recap-down" style="margin:0; padding-left:1rem;"></ul>
        </div>
      </div>

      <p class="muted"
         style="color:var(--muted,#666); font-size:.85rem;">
         Tip: click a node.
      </p>
    </aside>
  </div>


</section>
{% endblock %}
