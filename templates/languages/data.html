{% extends "base.html" %} 
{% load static %}

{% block title %}Language data{% endblock %}
{% block breadcrumb %}Languages / {{ language.id }} / Data{% endblock %}

{% block content %}
<main class="{% with s=lang_status.overall %}{% if not is_admin and s == 'waiting' or not is_admin and s == 'waiting_for_approval' or not is_admin and s == 'approved' or not is_admin and s == 'rejected' %}is-readonly{% endif %}{% endwith %}">
  <div class="card" style="display:flex; flex-wrap:wrap; gap:1rem; justify-content:space-between; align-items:flex-start;">
    <!-- Blocco titolo lingua -->
    <div style="min-width:12rem; flex:1 1 auto;">
      <h2 style="margin-top:0;">{{ language.name_full }} ({{ language.id }})</h2>
    </div>

    <!-- Blocco metadati lingua -->
    <div style="flex:1 1 16rem; max-width:32rem; font-size:.9rem; line-height:1.4;">
      <dl class="language-meta-grid" style="display:grid; grid-template-columns:auto 1fr; column-gap:.5rem; row-gap:.25rem; margin:0;">

        {# Glottocode #}
        <dt style="font-weight:600;">Glottocode</dt>
        <dd>
          {% if language.glottocode %}
            {{ language.glottocode }}
          {% else %}
            <span class="muted">—</span>
          {% endif %}
        </dd>

        {# ISO code #}
        <dt style="font-weight:600;">ISO code</dt>
        <dd>
          {% if language.isocode %}
            {{ language.isocode }}
          {% else %}
            <span class="muted">—</span>
          {% endif %}
        </dd>

        {# Family (non top-level: quella resta nella lista) #}
        {% if language.family %}
          <dt style="font-weight:600;">Family</dt>
          <dd>{{ language.family }}</dd>
        {% endif %}

        {# Historical #}
        <dt style="font-weight:600;">Historical</dt>
        <dd>
          {% if language.historical_language %}
            <span title="Historical language">Yes</span>
          {% else %}
            <span class="muted">—</span>
          {% endif %}
        </dd>

        {# Source #}
        <dt style="font-weight:600;">Source</dt>
        <dd>
          {% if language.source %}
            {{ language.source }}
          {% else %}
            <span class="muted">—</span>
          {% endif %}
        </dd>

        {# Supervisor #}
        {% if language.supervisor %}
          <dt style="font-weight:600;">Supervisor</dt>
          <dd>{{ language.supervisor }}</dd>
        {% endif %}

        {# Informant #}
        {% if language.informant %}
          <dt style="font-weight:600;">Informant</dt>
          <dd>{{ language.informant }}</dd>
        {% endif %}

        {# Assigned user: solo admin #}
        {% if is_admin %}
          <dt style="font-weight:600;">Assigned to</dt>
          <dd>
            {% if language.assigned_user %}
              {{ language.assigned_user.name }} {{ language.assigned_user.surname }}
            {% else %}
              <span class="muted">—</span>
            {% endif %}
          </dd>
        {% endif %}

      </dl>
    </div>
  </div>

   {# === Stato e azioni workflow === #}
  <div class="card workflow-card" style="margin-top:.5rem">

    <!-- BLOCCO STATO / INFO RIFIUTO, LARGO 100% -->
    <div class="workflow-status-block">
      <div class="workflow-status-line">
        <strong>Status:</strong>
        {% with s=lang_status.overall %}
          {% if s == "approved" %}
            <span class="badge b-ok">Approved</span>
          {% elif s == "waiting" or s == "waiting_for_approval" %}
            <span class="badge">Waiting for approval</span>
          {% elif s == "rejected" %}
            <span class="badge b-warn">Rejected</span>
          {% else %}
            <span class="badge b-warn">Pending</span>
          {% endif %}
        {% endwith %}
      </div>

      {% if last_reject %}
        {% with s=lang_status.overall %}
          {% if is_admin or s != 'approved' %}
            <div class="workflow-last-reject muted">
              <div class="last-reject-label">Last rejection:</div>
              <div class="last-reject-body">
                <div class="last-reject-meta">
                  {{ last_reject.created_at|date:"Y-m-d H:i" }}
                </div>
                <div class="last-reject-msg">
                  {% if last_reject.message %}
                    “{{ last_reject.message }}”
                  {% else %}
                    <em>no message provided</em>
                  {% endif %}
                </div>
              </div>
            </div>
          {% endif %}
        {% endwith %}
      {% endif %}
    </div>

    {% if is_admin %}
      {# === AZIONI ADMIN SU DUE COLONNE CENTRALI === #}
      <div class="workflow-action-grid">

        <!-- SAVE SUBMISSION + NOTE -->
        <form id="submission-create-form"
              class="workflow-form-block"
              method="post"
              action="{% url 'submission_create_for_language' language.id %}"
              {% if not all_answered %}data-confirm-missing="1"{% endif %}
              data-confirm-message="Warning: missing answers. Save anyway?">
          {% csrf_token %}
          <input type="hidden" name="next" value="{{ request.get_full_path }}">

          <button type="submit"
                  class="btn workflow-main-btn"
                  data-once="true"
                  title="Crea una nuova submission con lo stato attuale della lingua">
            Save submission
          </button>

          <details class="note-details">
            <summary class="details-toggle-btn" role="button" aria-expanded="false">
              ➜ Add submission note
            </summary>
            <div class="details-panel">
              <label for="note_{{ language.id }}" class="details-label">
                Submission note (optional)
              </label>
              <textarea id="note_{{ language.id }}"
                        name="note"
                        rows="2"
                        class="details-textarea"></textarea>
            </div>
          </details>
        </form>

        <!-- REJECT + NOTE -->
        <form method="post"
              class="workflow-form-block"
              action="{% url 'language_reject' language.id %}">
          {% csrf_token %}

          <button type="submit"
                  class="btn workflow-main-btn"
                  title="Rifiuta la submission della lingua">
            Reject
          </button>

          <details class="note-details reject-details">
            <summary class="details-toggle-btn" role="button" aria-expanded="false">
              ➜ Add rejection note
            </summary>
            <div class="details-panel">
              <label for="reject_message_{{ language.id }}" class="details-label">
                Rejection note (required to explain why)
              </label>
              <textarea id="reject_message_{{ language.id }}"
                        name="message"
                        rows="2"
                        class="details-textarea"></textarea>
            </div>
          </details>
        </form>

        <!-- DOWNLOAD -->
        <div class="workflow-form-block">
          <a href="{% url 'language_export_xlsx' language.id %}"
             class="btn workflow-secondary-btn"
             title="Download .xlsx">
            Download Excel
          </a>
        </div>

        <!-- APPROVE -->
        <form method="post"
              class="workflow-form-block"
              action="{% url 'language_approve' language.id %}">
          {% csrf_token %}
          {% if not all_answered %}
            <span class="hint-disabled"
                  title="Cannot approve while there are missing answers"
                  tabindex="0">
              <button type="submit"
                      class="btn btn--primary workflow-main-btn"
                      disabled
                      aria-disabled="true">
                Approve &amp; apply implications
              </button>
            </span>
          {% else %}
            <button type="submit"
                    class="btn btn--primary workflow-main-btn">
              Approve &amp; apply implications
            </button>
          {% endif %}
        </form>

      </div> <!-- /workflow-action-grid -->

    {% else %}
      {# === AZIONI USER (niente griglia complicata, ma usiamo lo stesso wrapper per coerenza) === #}
      <div class="workflow-action-grid">

        {% with s=lang_status.overall %}
          {% if s == 'rejected' %}
            <form method="post"
                  class="workflow-form-block"
                  action="{% url 'language_reopen' language.id %}">
              {% csrf_token %}
              <button type="submit"
                      class="btn btn--primary workflow-main-btn">
                Reopen
              </button>
              <span class="locked-hint">
                Language was rejected. Press “Reopen” to continue editing.
              </span>
            </form>

          {% elif s == 'pending' %}
            <form method="post"
                  class="workflow-form-block"
                  action="{% url 'language_submit' language.id %}">
              {% csrf_token %}
              <button type="submit"
                      class="btn btn--primary workflow-main-btn">
                Submit for review
              </button>
            </form>

          {% else %}
            <div class="workflow-form-block">
              <span class="hint-disabled"
                    title="{% if s == 'waiting_for_approval' or s == 'waiting' %}In attesa di revisione dell'admin{% else %}Già approvata dall'admin{% endif %}"
                    tabindex="0">
                <button type="button"
                        class="btn workflow-main-btn"
                        disabled
                        aria-disabled="true">
                  Submit for review
                </button>
              </span>
            </div>

            <div class="workflow-form-block">
              <a href="{% url 'language_export_xlsx' language.id %}"
                 class="btn workflow-secondary-btn"
                 title="Download .xlsx">
                Download .xlsx
              </a>
            </div>
          {% endif %}
        {% endwith %}

      </div> <!-- /workflow-action-grid -->
    {% endif %}
  </div><!-- /card workflow-card -->

    

  <!-- Barra di navigazione parametri -->
  <div class="param-nav" id="paramNav">
    {% for p in parameters %}
      <div
        class="param-btn"
        data-target="p-{{ p.id }}"
        data-status="{{ p.status }}"
        style="background:{{ p.bg_color }}; color:{{ p.fg_color }};"
        role="button"
        tabindex="0"
        title="Parameter {{ p.id }} — ..."
        aria-label="Parameter {{ p.id }}, ...">
        <span class="badge-review" aria-hidden="true" hidden>!</span> 
        {{ p.id }} 
      </div>
    {% endfor %}
  </div>

  {% for p in parameters %}
    <section id="p-{{ p.id }}" class="param-section card">
      <h3 class="param-title">
        {{ p.id }} — {{ p.name }}
        <label class="review-flag">
          <input
            type="checkbox"
            class="review-flag-input"
            data-param="{{ p.id }}"
            data-lang="{{ language.id }}"
            aria-label="Mark {{ p.id }} as 'to review'">
          <span class="muted small">Mark as needs review</span>
        </label>
      </h3>

      {% if p.short_description %}
        <p class="muted">{{ p.short_description }}</p>
      {% endif %}

      <form method="post" action="{% url 'parameter_save' language.id p.id %}">
        {% csrf_token %}
        {% for q in p.questions.all %}
          <div class="card" style="margin-bottom:.5rem">

            {# --- Testo domanda + help --- #}
            <p><strong>{{ q.id }}</strong> — {{ q.text }}</p>

            {% if q.example_yes %}
              <div class="muted" style="margin:.25rem 0 .5rem;">
                <strong>Example YES:</strong> {{ q.example_yes|linebreaksbr }}
              </div>
            {% endif %}

            {% if q.instruction %}
              <div class="muted" style="margin:.25rem 0 .5rem;">
                <strong>Instructions:</strong> {{ q.instruction|linebreaksbr }}
              </div>
            {% endif %}

            {% if q.help_info %}
              <details class="help-info">
                <summary><span aria-hidden="true">❓</span> More info</summary>
                <div class="muted">{{ q.help_info|linebreaksbr }}</div>
              </details>
            {% endif %}



            {# --- Answer select (YES/NO) --- #}
            <div class="qa-fields">
              <div>
                <label for="resp_{{ q.id }}">Answer</label>
                <select id="resp_{{ q.id }}" name="resp_{{ q.id }}" class="resp-select" data-qid="{{ q.id }}">
                  <option value="" {% if q.ans.response_text == "" %}selected{% endif %}>— seleziona —</option>
                  <option value="yes" {% if q.ans.response_text == "yes" %}selected{% endif %}>YES</option>
                  <option value="no"  {% if q.ans.response_text == "no"  %}selected{% endif %}>NO</option>
                </select>
              </div>

              {# BLOCCO NUOVO: istruzioni per YES #}
              <div class="yes-instruction-block"
                   data-qid="{{ q.id }}"
                   {% if q.ans.response_text|lower != "yes" %}style="display:none"{% endif %}>
                <div class="muted" style="margin:.25rem 0 .5rem;">
                  <strong>Instruction yes:</strong>
                  {% if q.instruction_yes %}
                    {{ q.instruction_yes|linebreaksbr }}
                  {% else %}
                    non fornita
                  {% endif %}
                </div>
              </div>
            </div>


            {# --- MOTIVATIONS (solo se risposta == NO) --- #}
            <div class="mot-block"
                 data-qid="{{ q.id }}"
                 {% if q.ans.response_text != "no" %}style="display:none"{% endif %}>
              <div class="muted" style="margin:.5rem 0 .25rem;">
                Select one or more motivations (if applicable).
              </div>

              <fieldset class="mot-checklist" aria-label="Motivations for NO" data-qid="{{ q.id }}">
                {% for m in q.allowed_motivations_list %}
                  <label class="checkbox-item" style="display:flex;gap:.5rem;align-items:flex-start;margin:.2rem 0;">
                    <input
                      type="checkbox"
                      name="mot_{{ q.id }}"
                      value="{{ m.id }}"
                      data-exclusive="{% if m.code == 'MOT1' %}1{% else %}0{% endif %}"
                      {% if m.id in q.ans.motivation_ids %}checked{% endif %}
                      {% with s=lang_status.overall %}
                        {% if not is_admin and s == 'waiting' or not is_admin and s == 'waiting_for_approval' or not is_admin and s == 'approved' or not is_admin and s == 'rejected' %}
                          disabled aria-disabled="true"
                        {% endif %}
                      {% endwith %}
                    >
                    <span>
                      <span><strong>{{ m.label|default:m.code }}</strong></span>
                    </span>
                  </label>
                {% empty %}
                  <div class="muted">No motivations configured for this question.</div>
                {% endfor %}
              </fieldset>
            </div>

            {# --- EXAMPLES BLOCK (visibile se c'è risposta yes/no) --- #}
            <div class="examples-block"
                 data-qid="{{ q.id }}"
                 data-template="{{ q.template_type|default:'linear' }}"
                 {% if q.ans.response_text == "" %}style="display:none"{% endif %}>

              <div class="toolbar" style="margin:.5rem 0">
                <strong>Examples</strong>
              </div>

              <p class="muted" style="margin:.25rem 0 .5rem;">
                Please provide the ungrammatical example. If the example cannot be provided, select the appropriate motivation(s) above.
              </p>

              <div class="field-error js-yes-examples-error" data-qid="{{ q.id }}" aria-live="polite" style="display:none"></div>


              <div class="examples-list" data-qid="{{ q.id }}">
                {% for ex in q.ans.examples %}
                  <div class="card example-row" style="margin-bottom:.5rem">
                    <div class="grid">
                      <div><label>Number</label><input name="ex_{{ ex.id }}_number" value="{{ ex.number }}"></div>
                      <div><label>Example text</label><input name="ex_{{ ex.id }}_textarea" value="{{ ex.textarea }}"></div>
                      <div><label>Transliteration</label><input name="ex_{{ ex.id }}_transliteration" value="{{ ex.transliteration }}"></div>
                      <div><label>Gloss</label><input name="ex_{{ ex.id }}_gloss" value="{{ ex.gloss }}"></div>
                      <div><label>English Translation</label><input name="ex_{{ ex.id }}_translation" value="{{ ex.translation }}"></div>
                      <div><label>Reference</label><input name="ex_{{ ex.id }}_reference" value="{{ ex.reference }}"></div>
                    </div>
                    <div class="toolbar" style="margin-top:.25rem">
                      <input type="hidden" name="del_ex_{{ ex.id }}" value="0">
                      <button class="btn btn-ex-toggle-delete"
                              type="button"
                              data-qid="{{ q.id }}"
                              data-exid="{{ ex.id }}"
                              {% with s=lang_status.overall %}
                                {% if not is_admin and s == 'waiting' or not is_admin and s == 'waiting_for_approval' or not is_admin and s == 'approved' or not is_admin and s == 'rejected' %}
                                  disabled aria-disabled="true" title="Editing bloccato fino alla revisione"
                                {% endif %}
                              {% endwith %}>Delete</button>
                    </div>
                  </div>
                {% empty %}
                  <div class="muted">No examples yet</div>
                {% endfor %}
              </div>

              <div>
                <button class="btn add-example-btn"
                        type="button"
                        data-qid="{{ q.id }}"
                        {% with s=lang_status.overall %}
                          {% if not is_admin and s == 'waiting' or not is_admin and s == 'waiting_for_approval' or not is_admin and s == 'approved' or not is_admin and s == 'rejected' %}
                            disabled aria-disabled="true" title="Editing bloccato fino alla revisione"
                          {% endif %}
                        {% endwith %}>Add example</button>
              </div>
            </div>

            {# --- COMMENTS (sempre alla fine, SEMPRE visibile) --- #}
            <div class="qa-fields" style="margin-top:1rem;">
              <div>
                <label for="com_{{ q.id }}">Comments</label>
                <textarea id="com_{{ q.id }}"
                          name="com_{{ q.id }}"
                          rows="2"
                          class="auto-grow"
                          data-autosize="1">{{ q.ans.comments }}</textarea>
              </div>
            </div>

          </div> {# fine .card della singola domanda #}
        {% endfor %}

        <div class="toolbar" style="margin-top:.75rem; display:flex; flex-direction:column; gap:.75rem;">

          <!-- riga SAVE -->
          <div style="display:flex; align-items:center; gap:.75rem; flex-wrap:wrap; width:100%;">
            <p class="muted" style="margin:0; font-size:.9rem;">
              Click <strong>Save</strong> if you are confident in your answer.  
              You can still edit or review it later.
            </p>
            <button type="submit"
                    class="btn btn--primary"
                    data-submit-action="save"
                    style="margin-left:auto;"
              {% with s=lang_status.overall %}
                {% if not is_admin and s == 'waiting' or not is_admin and s == 'waiting_for_approval' or not is_admin and s == 'approved' or not is_admin and s == 'rejected' %}
                  disabled aria-disabled="true" title="Editing blocked until review"
                {% endif %}
              {% endwith %}>
              Save {{ p.id }}
            </button>
          </div>

          <!-- riga NEXT -->
          <div style="display:flex; align-items:center; gap:.75rem; flex-wrap:wrap; width:100%;">
            <p class="muted" style="margin:0; font-size:.9rem;">
              Click <strong>Next</strong> if you are unsure and want to return to this parameter later.  
            </p>
            <button type="submit"
                    class="btn"
                    data-submit-action="next"
                    style="margin-left:auto;"
              {% with s=lang_status.overall %}
                {% if not is_admin and s == 'waiting' or not is_admin and s == 'waiting_for_approval' or not is_admin and s == 'approved' or not is_admin and s == 'rejected' %}
                  disabled aria-disabled="true" title="Editing blocked until review"
                {% endif %}
              {% endwith %}>
              Next
            </button>
          </div>

          <input type="hidden" name="action" value="save" data-action-field="1">
        </div>

      </form>
    </section>
  {% endfor %}
</main>
{% endblock %}


{% block extra_head %}
  <script src="{% static 'js/param_organize.js' %}"></script>
  <script src="{% static 'js/examples.js' %}"></script>
  <script src="{% static 'js/submission_create.js' %}"></script>
  <script src="{% static 'js/autosize_textarea.js' %}"></script>
  <script src="{% static 'js/instruction_yes.js' %}"></script>


  <style>
    .param-nav {display:flex; flex-wrap:wrap; gap:.4rem; margin-bottom:1rem;}
    .param-btn {
      width:2.4rem; height:2.4rem; border-radius:4px;
      display:flex; align-items:center; justify-content:center;
      cursor:pointer; font-weight:bold; border:2px solid rgba(0,0,0,.65);
      transition:transform .1s; position:relative;
      background-clip: padding-box;
    }
    .param-btn:hover {transform:scale(1.1);}
    .param-section {display:none;}
    .param-section.active {display:block;}

    /* === BLOCCO VISIVO (solo grafico) === */
    .is-readonly .card input,
    .is-readonly .card select,
    .is-readonly .card textarea {
      background: var(--surface-2, #f1f3f5);
      color: var(--muted-fg, #666);
      border-color: var(--border, #d0d7de);
      pointer-events: none;
    }
    .is-readonly .card input::placeholder,
    .is-readonly .card textarea::placeholder { color: #999; }
    .is-readonly .btn,
    .is-readonly .add-example-btn,
    .is-readonly .btn-ex-toggle-delete {
      opacity: .55; cursor: not-allowed; pointer-events: none;
    }
    .locked-hint { font-size: .9rem; color: #666; margin-left: .5rem; }
    .hint-disabled[title] { cursor: help; display: inline-block; }
    .is-readonly form[action$="reopen/"] .btn { opacity: 1; pointer-events: auto; cursor: pointer; }

    /* --------- Accessibilità stati parametri --------- */

    /* Colore bordo */
    .param-nav .param-btn {
      --edge: color-mix(in srgb, currentColor 55%, black);
    }

/* pulizia stati: niente giallo; usiamo inline bg/fg dalla view */
.param-nav .param-btn { border: 2px solid rgba(0,0,0,.65); border-radius: 6px; }

/* opzionale: i completi (ok) rotondi */
.param-nav .param-btn[data-status="ok"] { border-radius: 50%; }

/* untouched: nessuno sfondo, solo bordo standard */
.param-nav .param-btn[data-status="untouched"] { background: transparent !important; color: inherit !important; }


    /* Preferenze utente alta visibilità */
    @media (prefers-contrast: more) {
      .param-nav .param-btn[data-status="warn"] { border-width: 3px; }
      .param-nav .param-btn[data-status="missing"] { border-color: #000; }
      .param-nav .param-btn[data-status="ok"] { border-color: #000; }
    }

    /* Stacking verticale dei tre campi */
    .qa-fields {
      display: flex;
      flex-direction: column;
      gap: .75rem;
    }

    /* Textarea auto-espandibile, con limiti ragionevoli per mobile */
    textarea.auto-grow {
      width: 100%;
      min-height: 2.5rem;
      max-height: 40vh;
      overflow: hidden;
      resize: vertical;
    }

    /* Accessibilità: focus ben visibile */
    textarea.auto-grow:focus {
      outline: 2px solid var(--focus, #2266ff);
      outline-offset: 2px;
    }

    /* === Badge "to review" — pallino rosso a SINISTRA === */
    .param-btn { position: relative; }

    .param-btn .badge-review {
      position: absolute;
      top: -6px;
      left: -6px;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--bad, #b00020);
      border: 2px solid #fff;
      box-shadow: 0 0 0 1px rgba(0,0,0,.15);
      z-index: 2;
    }

    :root[data-theme="dark"] .param-btn .badge-review {
      border-color: var(--surface, #1e1f22);
    }

    @media (min-width: 1200px) {
      .param-btn .badge-review { width: 16px; height: 16px; top: -7px; left: -7px; }
    }

    /* forza il nascondimento quando c'è l'attributo hidden */
    .badge-review[hidden] { 
      display: none !important;
    }

    /* === Workflow header (status + azioni) ================================== */

.workflow-card {
  /* niente qui per ora, usa .card base */
}

/* griglia: su mobile va in colonna, su desktop 2 colonne */
.workflow-grid {
  row-gap: 1rem;
}

@media (min-width: 768px) {
  .workflow-grid {
    align-items: flex-start;
  }
}

.workflow-status-block {
  min-width: 12rem;
  font-size: .9rem;
  line-height: 1.4;
}

.workflow-status-line {
  display: flex;
  flex-wrap: wrap;
  gap: .5rem;
  align-items: center;
  font-size: 1rem;
  font-weight: 500;
}

.workflow-last-reject {
  margin-top: .5rem;
  padding: .5rem .75rem;
  border-left: 3px solid var(--bad, #b00020);
  background: var(--surface-2, rgba(0,0,0,0.03));
  border-radius: 4px;
}
:root[data-theme="dark"] .workflow-last-reject {
  background: rgba(255,255,255,0.05);
}

.workflow-last-reject .last-reject-label {
  font-weight: 600;
  margin-bottom: .25rem;
  color: var(--fg, #222);
}
:root[data-theme="dark"] .workflow-last-reject .last-reject-label {
  color: var(--fg, #fff);
}

.workflow-last-reject .last-reject-meta {
  font-size: .8rem;
  font-weight: 500;
  color: var(--muted-fg, #666);
  margin-bottom: .25rem;
}

.workflow-last-reject .last-reject-msg {
  font-size: .9rem;
  line-height: 1.4;
}

/* COLONNA DESTRA: blocchi azione */
.workflow-actions-block {
  font-size: .9rem;
  line-height: 1.4;
}

.workflow-action-group {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(min(16rem, 100%), 1fr));
  gap: 1rem 1.5rem;
  align-items: start;
  width: 100%;
}

/* Ogni "blocco azione" (form o div) è verticale */
.workflow-form-block {
  display: flex;
  flex-direction: column;
  align-items: stretch;
  gap: .5rem;
  min-width: 0;          /* evita overflow */
}

/* Pulsante principale e secondario riempiono larghezza blocco */
.workflow-main-btn,
.workflow-secondary-btn {
  width: 100%;
  text-align: center;
  min-height: 2.4rem;
  min-width: 10rem;
  justify-content: center;
}

/* === Dettagli note (Submission/Rejection) ============================== */

.note-details {
  width: 100%;
}


/* il <summary> viene stilizzato come bottone cliccabile */
.details-toggle-btn {
  list-style: none;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: .5rem;
  font-size: .85rem;
  font-weight: 600;
  line-height: 1.2;
  background: var(--surface-2, #f1f3f5);
  color: var(--fg, #222);
  border: 1px solid var(--border, #d0d7de);
  border-radius: 4px;
  padding: .4rem .5rem;
  user-select: none;
}

.details-toggle-btn:focus {
  outline: 2px solid var(--focus, #2266ff);
  outline-offset: 2px;
}

:root[data-theme="dark"] .details-toggle-btn {
  background: var(--surface-2, #2a2d31);
  color: var(--fg, #fff);
  border-color: var(--border, #555);
}

/* pannello espanso con textarea */
.details-panel {
  margin-top: .5rem;
  width: 100%;
  background: var(--surface, #fff);
  border: 1px solid var(--border, #d0d7de);
  border-radius: 4px;
  padding: .5rem .75rem .75rem;
  box-shadow: 0 1px 2px rgba(0,0,0,.05);
}

:root[data-theme="dark"] .details-panel {
  background: var(--surface, #1e1f22);
  border-color: var(--border, #555);
  box-shadow: 0 1px 2px rgba(0,0,0,.6);
}

.details-label {
  font-size: .8rem;
  font-weight: 500;
  display: block;
  margin-bottom: .25rem;
  color: var(--fg, #222);
}
:root[data-theme="dark"] .details-label {
  color: var(--fg, #fff);
}

.details-textarea {
  width: 100%;
  min-width: 100%;
  min-height: 3rem;
  max-height: 30vh;
  resize: vertical;
  line-height: 1.4;
  font-size: .9rem;
  padding: .4rem .5rem;
  border-radius: 4px;
  border: 1px solid var(--border, #d0d7de);
  background: var(--surface, #fff);
  color: var(--fg, #222);
}

:root[data-theme="dark"] .details-textarea {
  background: var(--surface-2, #2a2d31);
  color: var(--fg, #fff);
  border-color: var(--border, #555);
}

/* per differenziare visivamente la rejection note se vuoi più enfasi */
.reject-details .details-panel {
  border-left: 3px solid var(--bad, #b00020);
}

/* responsive: su schermi stretti mettiamo i blocchi azione uno sotto l'altro */
@media (max-width: 600px) {
  .workflow-actions-block {
    justify-content: flex-start;
    text-align: left;
  }
  .workflow-action-group {
    grid-template-columns: 1fr;
  }
  .workflow-form-block {
    width: 100%;
    max-width: 100%;
  }
  .workflow-main-btn,
  .workflow-secondary-btn {
    width: 100%;
  }
}

/* === Workflow card layout v2 ========================================= */

/* la card già usa .card dal css globale */
.workflow-card {
  display: block;
}

/* blocco stato in alto */
.workflow-status-block {
  margin-bottom: 1rem;
  font-size: .9rem;
  line-height: 1.4;
}

.workflow-status-line {
  display: flex;
  flex-wrap: wrap;
  gap: .5rem;
  align-items: center;
  font-size: 1rem;
  font-weight: 500;
}

/* messaggio ultimo rifiuto già definito prima, lo teniamo identico */

/* griglia delle azioni:
   - 2 colonne su desktop/tablet
   - 1 colonna su mobile
   - max-width centrale per non andare troppo ai bordi
*/
.workflow-action-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(min(22rem,100%), 1fr));
  gap: 1rem 1.5rem;
  align-items: start;

  max-width: 60rem;         /* limita la larghezza per evitare "tutto schiacciato ai lati" */
  margin: 0 auto;           /* CENTRA la griglia dentro la card */
  width: 100%;
}

/* ogni blocco (save+note, reject+note, download, approve) */
.workflow-form-block {
  display: flex;
  flex-direction: column;
  align-items: stretch;
  gap: .5rem;
  min-width: 0;
  background: var(--surface-2);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: .75rem 1rem;
  box-shadow: 0 1px 2px rgba(0,0,0,.06);
}
:root[data-theme="dark"] .workflow-form-block {
  background: var(--surface-2);
  box-shadow: 0 1px 2px rgba(0,0,0,.6);
}

/* pulsanti dentro i blocchi: full width */
.workflow-main-btn,
.workflow-secondary-btn {
  width: 100%;
  text-align: center;
  min-height: 2.4rem;
  min-width: 10rem;
  justify-content: center;
}

/* la sezione note rimane subito sotto */
.note-details {
  width: 100%;
}

/* mobile force 1 colonna */
@media (max-width: 600px) {
  .workflow-action-grid {
    grid-template-columns: 1fr;
    max-width: 28rem;
  }
}


  </style>
{% endblock %}

{% block extra_js %}
<script>
// CSRF
function getCookie(name) {
  const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
  return m ? m.pop() : '';
}
const csrftoken = getCookie('csrftoken');

document.querySelectorAll('.badge-review').forEach(b => b.hidden = true);

// A) Fetch dei flag per l'utente corrente su questa lingua
(async function initReviewFlags(){
  try {
    const url = "{% url 'review_flags_list' language.id %}";
    const resp = await fetch(url, { headers: { 'Accept': 'application/json' }});
    if (!resp.ok) return;
    const data = await resp.json();  // { flags: ["FGM", "FGA", ...] }
    const flagged = new Set(data.flags || []);

    // 1) set checkboxes
    document.querySelectorAll('.review-flag-input').forEach(cb => {
      const pid = cb.dataset.param;
      cb.checked = flagged.has(pid);
    });

    // 2) badge sui quadratini
    document.querySelectorAll('.param-btn').forEach(btn => {
      const pid = (btn.dataset.target || '').replace(/^p-/, '');
      const badge = btn.querySelector('.badge-review');
      if (!badge) return;
      if (flagged.has(pid)) {
        badge.hidden = false;
        badge.setAttribute('aria-label', 'Marked to review');
      } else {
        badge.hidden = true;
      }
    });
  } catch(e) { /* silenzioso */ }
})();

// B) Toggle salvataggio immediato (AJAX) quando spunti la checkbox
document.addEventListener('change', async function(e){
  const el = e.target;
  if (!el.classList || !el.classList.contains('review-flag-input')) return;
  const pid = el.dataset.param;
  const lang = el.dataset.lang;
  const flag = el.checked ? '1' : '0';

  try {
    const url = "{% url 'toggle_review_flag' 'LANG' 'PARAM' %}"
      .replace('LANG','__LANG__').replace('PARAM','__PARAM__')
      .replace('__LANG__', encodeURIComponent(lang))
      .replace('__PARAM__', encodeURIComponent(pid));
    const resp = await fetch(url, {
      method: 'POST',
      headers: { 'X-CSRFToken': csrftoken, 'Accept': 'application/json' },
      body: new URLSearchParams({ flag })
    });
    if (!resp.ok) throw new Error('Bad response');

    // Aggiorna badge immediatamente
    const btn = document.querySelector(`.param-btn[data-target="p-${pid}"] .badge-review`);
    if (btn) btn.hidden = (flag !== '1');
  } catch (err) {
    alert('Errore nel salvataggio del promemoria. Riprova.');
    // revert UI
    el.checked = !el.checked;
  }
});
</script>

<script>
// Imposta il campo hidden "action" in base al bottone premuto (save/next)
document.addEventListener('click', function(e){
  const btn = e.target.closest('button[data-submit-action]');
  if (!btn) return;
  const form = btn.closest('form');
  if (!form) return;
  const hidden = form.querySelector('input[data-action-field]');
  if (!hidden) return;
  hidden.value = btn.getAttribute('data-submit-action'); // "save" | "next"
});
</script>

{% endblock %}
