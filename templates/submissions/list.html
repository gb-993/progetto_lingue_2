{% extends "base.html" %}
{% block title %}Backup History{% endblock %}

{% block breadcrumb %}
  <li aria-current="page">Backup</li>
{% endblock %}


{% block content %}

<header class="dashboard-hero" style="margin-bottom: 2rem;">
    {% if is_folder_view %}
        <h1>Backup History</h1>
    {% else %}
        <div class="d-flex align-items-center gap-3">
             <a href="{% url 'submissions_list' %}" class="btn btn-outline-secondary">‚Üê Torna alle cartelle</a>
             <div>
                <h1 class="m-0">Backup del {{ selected_ts }}</h1>
             </div>
        </div>
    {% endif %}
</header>

<section class="toolbar" role="search" style="margin-bottom: 1.5rem;">
  <form method="get" class="toolbar__form d-flex gap-2">
    <input id="q" name="q" class="form-control" type="search" value="{{ q|default:'' }}"
           placeholder="{% if is_folder_view %}Cerca backup...{% else %}Cerca lingua...{% endif %}">

    {% if selected_ts %}
        <input type="hidden" name="timestamp" value="{{ selected_ts }}">
        {% if sort %}<input type="hidden" name="sort" value="{{ sort }}">{% endif %}
        {% if dir %}<input type="hidden" name="dir" value="{{ dir }}">{% endif %}
    {% endif %}

    <button class="btn btn-primary" type="submit">Cerca</button>

    {% if is_folder_view and is_admin %}
         <a class="btn btn-warning" href="{% url 'submission_create_all' %}" style="background-color: #ff4500; color: white; border:none; margin-left:auto;">
            + Crea Nuovo Backup Totale
        </a>
    {% endif %}
  </form>
</section>

<div class="table-responsive">
  <table class="table table-hover align-middle">
    <thead class="table-light">
      {% if is_folder_view %}
        <tr>
          <th style="width: 50px;"></th>
          <th>Data Backup</th>
          <th>Nota</th>
          <th>Lingue</th>
          <th>Utente</th>
          <th style="text-align: right;">Azioni</th>
        </tr>
      {% else %}
        <tr>
          <th scope="col">
            <a href="{{ sort_urls.name }}" class="sort-link {% if sort == 'name' %}active{% endif %}">
              Language Name
              <span class="sort-indicator">
                {% if sort == 'name' %}{% if dir == 'asc' %}‚Üë{% else %}‚Üì{% endif %}{% else %}‚Üï{% endif %}
              </span>
            </a>
          </th>

          <th scope="col">
            <a href="{{ sort_urls.id }}" class="sort-link {% if sort == 'id' %}active{% endif %}">
              ID
              <span class="sort-indicator">
                {% if sort == 'id' %}{% if dir == 'asc' %}‚Üë{% else %}‚Üì{% endif %}{% else %}‚Üï{% endif %}
              </span>
            </a>
          </th>

          <th>Stato</th>
          <th style="text-align: right;">Dettagli</th>
        </tr>
      {% endif %}
    </thead>

    <tbody>
      {% if is_folder_view %}
        {# --- LOOP CARTELLE --- #}
        {% for g in page.object_list %}
          <tr>
            <td style="font-size: 1.5rem;">üìÅ</td>
            <td><strong>{{ g.submitted_at|date:"Y-m-d H:i:s" }}</strong></td>
            <td>{{ g.note|default:"-" }}</td>
            <td><span class="badge rounded-pill bg-secondary">{{ g.lang_count }}</span></td>
            <td><small>{{ g.submitted_by__email }}</small></td>
            <td style="text-align: right; white-space: nowrap;">
                <div style="display: inline-flex; align-items: center; gap: 10px; justify-content: flex-end;">

                    <a class="btn btn-sm btn-primary"
                       href="?timestamp={{ g.submitted_at|date:'Y-m-d H:i:s' }}">
                        Open folder
                    </a>

                    <form method="post" action="{% url 'submission_delete_backup' %}"
                          onsubmit="return confirm('Sei sicuro di voler eliminare questo backup?');"
                          style="margin: 0; display: inline-block;">
                        {% csrf_token %}
                        <input type="hidden" name="timestamp" value="{{ g.submitted_at|date:'Y-m-d H:i:s' }}">

                        <button type="submit" class="btn btn-sm btn-danger" title="Delete"
                                style="background-color: #dc3545 !important; border-color: #dc3545 !important; color: white !important;">
                            Delete
                        </button>
                    </form>
                </div>

            </td>
          </tr>
        {% empty %}
          <tr><td colspan="6" class="text-center py-4">Nessun backup trovato.</td></tr>
        {% endfor %}

      {% else %}
        {# --- LOOP LINGUE --- #}
        {% for s in page.object_list %}
          <tr>
            <td><strong>{{ s.language.name_full }}</strong></td>
            <td><code>{{ s.language_id }}</code></td>
            <td><span class="badge bg-success">Salvato</span></td>
            <td style="text-align: right;">
               <a class="btn btn-sm btn-outline-primary" href="{% url 'submission_detail' s.id %}">Vedi Dati</a>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="4" class="text-center py-4">Nessuna lingua trovata.</td></tr>
        {% endfor %}
      {% endif %}
    </tbody>
  </table>
</div>

{% if page.has_other_pages %}
<nav class="pagination d-flex justify-content-center mt-4">
  <div class="btn-group">
      {% if page.has_previous %}
        <a class="btn btn-outline-secondary" href="?page={{ page.previous_page_number }}{% if q %}&q={{ q }}{% endif %}{% if selected_ts %}&timestamp={{ selected_ts }}&sort={{ sort }}&dir={{ dir }}{% endif %}">Precedente</a>
      {% endif %}
      <span class="btn btn-disabled disabled">Pagina {{ page.number }} di {{ page.paginator.num_pages }}</span>
      {% if page.has_next %}
        <a class="btn btn-outline-secondary" href="?page={{ page.next_page_number }}{% if q %}&q={{ q }}{% endif %}{% if selected_ts %}&timestamp={{ selected_ts }}&sort={{ sort }}&dir={{ dir }}{% endif %}">Successiva</a>
      {% endif %}
  </div>
</nav>
{% endif %}

<style>
  /* Stili copiati e adattati da list.html originale */
  .sort-link {
    text-decoration: none;
    color: inherit;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    font-weight: 600;
  }
  .sort-link:hover {
    color: #ff4500;
  }
  .sort-indicator {
    font-size: 0.8rem;
    opacity: 0.3;
  }
  .sort-link.active .sort-indicator {
    opacity: 1;
    color: #ff4500;
    font-weight: bold;
  }

  /* --- MOBILE BACKUP LIST (< 900px) --- */
@media (max-width: 900px) {

    /* 1. Header e Toolbar */
    .dashboard-hero {
        text-align: center;
        flex-direction: column;
        gap: 1rem;
    }
    .toolbar__form {
        flex-direction: column;
    }
    .toolbar__form input,
    .toolbar__form button,
    .toolbar__form a.btn {
        width: 100%;
        margin: 0 !important; /* Reset margini inline */
    }

    /* 2. Trasformiamo la tabella in una lista di Card */
    .table thead { display: none; }

    .table tbody tr {
        display: flex;
        flex-direction: column;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 1rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        gap: 0.5rem;
    }

    .table tbody td {
        display: block;
        padding: 0;
        border: none;
        width: 100%;
        text-align: left !important; /* Sovrascrive allineamenti inline */
    }

    /* --- SPECIFICO PER VISTA CARTELLE (Folder View) --- */
    /* td1: Icona, td2: Data, td3: Nota, td4: Lingue, td5: Email, td6: Azioni */

    /* Icona cartella e Data sulla stessa riga visiva */
    .table tbody tr td:first-child {
        font-size: 1.2rem;
        margin-bottom: -1.5rem; /* Trucco per sovrapporlo */
    }
    .table tbody tr td:nth-child(2) {
        padding-left: 2rem; /* Spazio per l'icona */
        font-size: 1.1rem;
        color: var(--brand);
        margin-bottom: 0.5rem;
    }

    /* Label per Nota e Utente */
    .table tbody tr td:nth-child(3)::before { content: "Note: "; font-weight: bold; color: var(--text-muted); }
    .table tbody tr td:nth-child(5)::before { content: "User: "; font-weight: bold; color: var(--text-muted); }

    /* Badge numero lingue */
    .table tbody tr td:nth-child(4) {
        order: -1; /* Lo spostiamo in alto a destra se possibile, o lasciamo flow */
        margin-bottom: 0.5rem;
    }

    /* Azioni (Bottoni) */
    .table tbody tr td:last-child {
        margin-top: 1rem;
        border-top: 1px dashed var(--border);
        padding-top: 1rem;
    }
    .table tbody tr td:last-child > div {
        width: 100%;
        display: flex;
        flex-direction: column; /* Bottoni impilati */
        gap: 0.5rem;
    }
    .table tbody tr td:last-child .btn {
        width: 100%;
        justify-content: center;
    }

    /* --- SPECIFICO PER VISTA LINGUE (Language View) --- */
    /* Se la tabella ha meno colonne (4), adattiamo */

    /* Nome lingua */
    .table tbody tr td:nth-child(1) strong {
        font-size: 1.2rem;
        color: var(--text);
    }

    /* ID lingua */
    .table tbody tr td:nth-child(2) {
        font-family: var(--mono);
        color: var(--text-muted);
        margin-bottom: 0.5rem;
    }

    /* Bottone Vedi Dati */
    .table tbody tr td:last-child a.btn {
        display: flex;
        width: 100%;
        margin-top: 0.5rem;
        justify-content: center;
    }
}
</style>
{% endblock %}