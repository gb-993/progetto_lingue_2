{% extends "base.html" %}
{% load i18n %}
{% load static %}

{% block title %}{% if is_create %}Add parameter{% else %}Edit parameter{% endif %}{% endblock %}
{% block breadcrumb %}Parameters / {% if is_create %}Add{% else %}{{ parameter.id }}{% endif %}{% endblock %}

{% block extra_head %}
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
  <script defer src="{% static 'js/parameter_edit.js' %}"></script>
  <style>
    /* Lightweight row style for questions */
    .q-list { display: grid; gap: .5rem; }
    .q-row {
      display: flex; align-items: flex-start; justify-content: space-between;
      gap: .75rem; padding: .75rem .9rem;
      background: var(--surface, #fff); border: 1px solid var(--border, #dadde2);
      border-radius: .6rem;
    }
    .q-row__text { flex: 1 1 auto; min-width: 0; }
    .q-row__id { font-weight: 600; margin-right: .5rem; white-space: nowrap; }
    .q-row__actions { flex: 0 0 auto; display: inline-flex; gap: .5rem; }
    .q-section-title { margin: .25rem 0 .5rem; color: var(--text-muted,#61656b); font-weight: 600; }
  </style>
{% endblock %}

{% block content %}
<section class="card" aria-labelledby="param-heading">
  <h2 id="param-heading">{% if is_create %}Add parameter{% else %}Parameter {{ parameter.id }}{% endif %}</h2>

  <form id="param-edit-form" method="post" novalidate
        {% if not is_create %}
          data-requires-change-note="true"
          data-change-note-name="{{ form.change_note.html_name|escapejs }}"
        {% endif %}
        data-tracked='[
          "{{ form.name.html_name|escapejs }}",
          "{{ form.short_description.html_name|escapejs }}",
          "{{ form.implicational_condition.html_name|escapejs }}",
          "{{ form.is_active.html_name|escapejs }}",
          "{{ form.position.html_name|escapejs }}"{% if form.warning_default %}
          , "{{ form.warning_default.html_name|escapejs }}"{% endif %}
        ]'>

    {% csrf_token %}

    {% if is_create %}
      <div class="form-row">
        {{ form.id.label_tag }} {{ form.id }}
        {% if form.id.errors %}<div class="form-error">{{ form.id.errors }}</div>{% endif %}
      </div>
    {% else %}
      <div class="form-row">
        {{ form.id.label_tag }}
        <input class="form-control" value="{{ form.id.value|default_if_none:'' }}" readonly>
        {{ form.id.as_hidden }}
        <p class="muted">ID is not editable.</p>
      </div>
    {% endif %}

    <div class="form-row">
      {{ form.name.label_tag }} {{ form.name }}
      {% if form.name.errors %}<div class="form-error">{{ form.name.errors }}</div>{% endif %}
    </div>

    <div class="form-row">
      {{ form.short_description.label_tag }} {{ form.short_description }}
      {% if form.short_description.errors %}<div class="form-error">{{ form.short_description.errors }}</div>{% endif %}
    </div>

    <div class="form-row">
      {{ form.implicational_condition.label_tag }} {{ form.implicational_condition }}
      {% if form.implicational_condition.errors %}<div class="form-error">{{ form.implicational_condition.errors }}</div>{% endif %}
      <p class="help">Use tokens like <code>+FGM</code>, <code>-SCO</code>, <code>0ABC</code>, without spaces between sign and ID.</p>
    </div>

    {# === Active with guard when deactivation is not allowed === #}
    <div class="form-row">
      <label for="{{ form.is_active.id_for_label }}">Active</label>

      {% if form.instance.is_active and not can_deactivate %}
        <input
          type="checkbox"
          id="{{ form.is_active.id_for_label }}"
          checked
          disabled
          aria-disabled="true"
        >
        <input type="hidden" name="{{ form.is_active.html_name }}" value="1">
        <p class="hint b-bad" role="note">
          Cannot deactivate: other parameters reference this ID. See the list below and clean their conditions first.
        </p>
      {% else %}
        {{ form.is_active }}
      {% endif %}

      {% if form.is_active.errors %}<div class="form-error">{{ form.is_active.errors }}</div>{% endif %}
    </div>

    <div class="form-row">
      {{ form.position.label_tag }} {{ form.position }}
      {% if form.position.errors %}<div class="form-error">{{ form.position.errors }}</div>{% endif %}
    </div>

    <div class="form-row">
      <label class="sr-only" for="{{ form.warning_default.id_for_label }}">Warning default</label>
      {{ form.warning_default }}
      {% if form.warning_default.errors %}<div class="form-error">{{ form.warning_default.errors }}</div>{% endif %}
    </div>

    {% if not is_create %}
      {# =========================
         QUESTIONS (compact rows)
         ========================= #}
      <fieldset class="form-row" aria-labelledby="questions-heading">
        <legend id="questions-heading">Questions for this parameter</legend>

        <div class="actions" style="margin-bottom: .5rem;">
          <a class="btn btn--primary" href="{% url 'question_add' parameter.id %}">Add question</a>
        </div>

        <div class="grid grid--2">
          <div>
            <h4 class="q-section-title">Normal questions</h4>
            {% if questions_normal and questions_normal|length > 0 %}
              <div class="q-list">
                {% for q in questions_normal %}
                  <div class="q-row">
                    <div class="q-row__text">
                      <span class="q-row__id">{{ q.id }}</span>
                      <span>{{ q.text }}</span>
                    </div>
                    <div class="q-row__actions">
                      <a class="btn" href="{% url 'question_edit' parameter.id q.id %}">Edit</a>
                      <a class="btn btn--danger" href="{% url 'question_delete' parameter.id q.id %}">Delete</a>
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <p class="muted">No normal questions.</p>
            {% endif %}
          </div>

          <div>
            <h4 class="q-section-title">Stop questions</h4>
            {% if questions_stop and questions_stop|length > 0 %}
              <div class="q-list">
                {% for q in questions_stop %}
                  <div class="q-row">
                    <div class="q-row__text">
                      <span class="q-row__id">{{ q.id }}</span>
                      <span>{{ q.text }}</span>
                    </div>
                    <div class="q-row__actions">
                      <a class="btn" href="{% url 'question_edit' parameter.id q.id %}">Edit</a>
                      <a class="btn btn--danger" href="{% url 'question_delete' parameter.id q.id %}">Delete</a>
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <p class="muted">No stop questions.</p>
            {% endif %}
          </div>
        </div>
      </fieldset>
    {% endif %}

    {% if not is_create %}
      {# === Change recap AT THE BOTTOM === #}
      <fieldset class="form-row" aria-labelledby="change-note-heading">
        <legend id="change-note-heading" class="sr-only">Change recap</legend>
        {{ form.change_note.label_tag }} {{ form.change_note }}
        {% if form.change_note.errors %}<div class="form-error">{{ form.change_note.errors }}</div>{% endif %}
        <p id="changeNoteHint" class="help">Required if you modified one or more fields of this parameter.</p>
      </fieldset>
    {% endif %}

    <div class="actions">
      <button id="saveBtn" type="submit" class="btn btn--primary" aria-disabled="false">Save</button>
      <a class="btn" href="{% url 'parameter_list' %}">Back</a>
    </div>
  </form>
</section>

<section class="card" aria-labelledby="where-used-heading">
  <h3 id="where-used-heading">Who references this parameter</h3>
  {% if where_used and where_used|length > 0 %}
    <p class="muted">The following parameters reference this ID in their implicational condition. Edit their conditions before deactivating this parameter.</p>
    <ul class="list">
      {% for target, cond in where_used %}
        <li>
          <a href="{% url 'parameter_edit' target.id %}"><strong>{{ target.id }}</strong> â€” {{ target.name }}</a>
          <div class="muted"><code>{{ cond }}</code></div>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="muted">No parameter references this ID. You can proceed with deactivation (password required).</p>
  {% endif %}
</section>

{% if can_deactivate %}
<section class="card" aria-labelledby="deactivate-heading">
  <h3 id="deactivate-heading">Deactivate parameter</h3>
  <p>This will set the parameter as inactive. Confirm with your password.</p>
  <form method="post" action="{% url 'parameter_deactivate' parameter.id %}" novalidate>
    {% csrf_token %}
    <div class="form-row">
      {{ deactivate_form.password.label_tag }}
      {{ deactivate_form.password }}
      {% if deactivate_form.password.errors %}<div class="form-error">{{ deactivate_form.password.errors }}</div>{% endif %}
    </div>
    <div class="form-row">
      {{ deactivate_form.reason.label_tag }}
      {{ deactivate_form.reason }}
      {% if deactivate_form.reason.errors %}<div class="form-error">{{ deactivate_form.reason.errors }}</div>{% endif %}
    </div>
    {% if deactivate_form.non_field_errors %}
      <div class="form-error">{{ deactivate_form.non_field_errors }}</div>
    {% endif %}
    <div class="actions">
      <button type="submit" class="btn btn--danger">Confirm deactivation</button>
    </div>
  </form>
</section>
{% endif %}
{% endblock %}
