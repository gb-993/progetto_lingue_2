{% extends "base.html" %}
{% load static %}

{% block title %}Account{% endblock %}
{% block breadcrumb %}Accounts / {{ page_title }}{% endblock %}

{# carico lo stesso JS usato in edit per filtrare / sincronizzare le lingue #}
{% block extra_head %}
  <script defer src="{% static 'js/account_languages.js' %}"></script>
{% endblock %}

{% block content %}
  <div class="card">
    <h3>{{ page_title }}</h3>

    <form method="post" novalidate>
      {% csrf_token %}

      {# errori non di campo #}
      {% if form.non_field_errors %}
        <div class="alert alert--error" role="alert">
          {{ form.non_field_errors }}
        </div>
      {% endif %}

      <div class="grid grid-2">
        <div class="form-group">
          <label for="{{ form.email.id_for_label }}">Email</label>
          {{ form.email }}
          {% if form.email.errors %}
            <div class="field-error" role="alert">{{ form.email.errors|striptags }}</div>
          {% endif %}
        </div>

        <div class="form-group">
          <label for="{{ form.role.id_for_label }}">Role</label>
          {{ form.role }}
          {% if form.role.errors %}
            <div class="field-error" role="alert">{{ form.role.errors|striptags }}</div>
          {% endif %}
        </div>

        <div class="form-group">
          <label for="{{ form.name.id_for_label }}">Name</label>
          {{ form.name }}
          {% if form.name.errors %}
            <div class="field-error" role="alert">{{ form.name.errors|striptags }}</div>
          {% endif %}
        </div>

        <div class="form-group">
          <label for="{{ form.surname.id_for_label }}">Surname</label>
          {{ form.surname }}
          {% if form.surname.errors %}
            <div class="field-error" role="alert">{{ form.surname.errors|striptags }}</div>
          {% endif %}
        </div>

        {# In ADD mostriamo la password obbligatoria #}
        {% if show_password %}
          <div class="form-group" style="grid-column:1/-1">
            <label for="{{ form.password.id_for_label }}">Password</label>
            {{ form.password }}
            {% if form.password.errors %}
              <div class="field-error" role="alert">{{ form.password.errors|striptags }}</div>
            {% endif %}
            {# puoi riattivare questo se vuoi spiegare la policy
            <p class="muted">La password è obbligatoria solo in creazione.</p>
            #}
          </div>
        {% endif %}

        {# === LINGUE: stessa struttura di edit === #}
        <div class="form-group" style="grid-column:1/-1">
          <!-- <fieldset> -->
            <!-- <legend id="lang-legend">Assigned languages (optional)</legend> -->

            {# Nota admin: in add l'utente ancora non esiste.
               Però possiamo già avvisare se stiamo creando direttamente un admin #}
            {% if form.role.value == "admin" %}
              <p class="muted" aria-live="polite">
                This user is an <strong>admin</strong> and can access <strong>all</strong> languages.
                The list below still shows any explicit assignments
              </p>
            {% endif %}

            {# Barra di ricerca #}
            <div class="form-row" style="margin-bottom:.5rem;">
              <label for="lang-search" class="sr-only">Cerca lingue</label>
              <input id="lang-search" type="search" class="form-control"
                     placeholder="Cerca lingue… (codice o nome)" aria-describedby="lang-help">
            </div>

            {# Lista checkbox lingua: codice — nome completo #}
            <div id="lang-list" class="checkbox-list" role="group" aria-labelledby="lang-legend"
                 style="max-height:16rem; overflow:auto; border:1px solid var(--border); border-radius:6px; padding:.5rem;">
              {% for lang in languages %}
                <label class="checkbox-item"
                       data-search="{{ lang.id|lower }} {{ lang.name_full|lower }}"
                       style="display:flex; align-items:center; gap:.5rem; padding:.25rem .25rem;">
                  <input type="checkbox" name="lang_ids" value="{{ lang.id }}"
                         {% if lang.id in selected_lang_ids %}checked{% endif %}>
                  <span><strong>{{ lang.id }}</strong> — {{ lang.name_full }}</span>
                </label>
              {% empty %}
                <p class="muted">Nessuna lingua disponibile.</p>
              {% endfor %}
            </div>

            {# Riepilogo selezionate (vuoto inizialmente, popolato da JS) #}
            <div class="muted" aria-live="polite" style="margin-top:.5rem;">
              <strong>Selezionate:</strong>
              <ul id="lang-selected" style="margin:.25rem 0 0 .75rem;">
                {% for lang in languages %}
                  {% if lang.id in selected_lang_ids %}
                    <li data-id="{{ lang.id }}"><strong>{{ lang.id }}</strong> — {{ lang.name_full }}</li>
                  {% endif %}
                {% endfor %}
              </ul>
              {% if not selected_lang_ids %}Nessuna lingua selezionata.{% endif %}
            </div>
          </fieldset>
        </div>
        {# === /LINGUE === #}

      </div> {# /.grid grid-2 #}

      <div class="toolbar">
        <a class="btn" href="{% url 'accounts_list' %}">Cancel</a>
        <button class="btn btn--primary">Save</button>
      </div>
    </form>
  </div>
{% endblock %}
