{% extends "base.html" %}
{% block title %}Edit language{% endblock %}
{% block breadcrumb %}
  <li><a href="{% url 'language_list' %}">Languages</a></li>
  <li>{{ language.id }}</li>
  <li aria-current="page">Edit</li>
{% endblock %}


{% block content %}
  <div class="card">
    <h2 class="h3">Edit language — {{ language.name_full }} ({{ language.id }})</h2>

    <form method="post" novalidate>
      {% csrf_token %}
      {{ form.non_field_errors }}

      <div class="grid grid-2">
          {% for field in form %}
              {% if field.name != "assigned_user" %}
                <div class="form-row">
                  <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                  {{ field }}
                  {% if field.errors %}<div class="error">{{ field.errors|striptags }}</div>{% endif %}
                  {% if field.help_text %}<div class="muted">{{ field.help_text }}</div>{% endif %}
                </div>
              {% else %}
                {# Questo impedisce a Django di svuotare il campo al salvataggio #}
                {{ field.as_hidden }}
              {% endif %}
          {% endfor %}

        {# --- Campo di sola lettura per l'assegnatario --- #}
        <div class="form-row">
          <label>Assigned to</label>
            <div class="form-control is-plaintext" aria-readonly="true">
              {% if language.users.exists %}
                <ul style="margin: 0; padding-left: 1.2rem;">
                  {% for u in language.users.all %}
                    <li>{{ u.name }} {{ u.surname }} ({{ u.email }})</li>
                  {% endfor %}
                </ul>
              {% elif language.assigned_user %}
                {# Fallback per eventuali vecchi dati non ancora migrati #}
                {{ language.assigned_user.name }} {{ language.assigned_user.surname }} ({{ language.assigned_user.email }})
              {% else %}
                <span class="muted">—</span>
              {% endif %}
            </div>
          <div class="muted">
            <a href="{% url 'accounts_list' %}" class="link-muted">
              Editable from the account page
            </a>
          </div>
        </div>

      </div>

      <div class="toolbar" style="display: flex; justify-content: flex-end; gap: 10px;">
        <button class="btn btn--primary">Save</button>
        <a class="btn" href="{% url 'language_list' %}">Cancel</a>
      </div>
    </form>
    
    {% if request.user.is_staff or request.user.is_superuser or request.user.role == 'admin' %}
      <hr>
      <form method="post"
            action="{% url 'language_delete' language.id %}"
            onsubmit="return confirm('WARNING: All data linked to this language (answers, examples, submissions, logs, etc.) will be PERMANENTLY deleted. Do you want to continue?')"
            style="display:block; margin-top:1.5rem; padding-top:1rem; clear:both; max-width:50rem;">
        {% csrf_token %}
        <label for="admin_password" class="muted" style="display:block; margin-bottom:.25rem;">
          Type your password to delete this language
        </label>
        <div style="display: flex; justify-content: flex-start; gap: 10px; align-items: center;">
          <input type="password"
                id="admin_password"
                name="admin_password"
                class="form-control"
                required
                style="width:100%; max-width:15rem;">
          <button type="submit" class="btn btn--danger" style="min-width: 10rem;">
            Delete language
          </button>
        </div>
      </form>
    {% endif %}


  </div>
{% endblock %}
