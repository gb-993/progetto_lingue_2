{% extends "base.html" %}
{% block title %}Parameters Debug — {{ language.id }}{% endblock %}

{% block breadcrumb %}
  <li><a href="{% url 'language_list' %}">Languages</a></li>
  <li>{{ language.id }}</li>
  <li aria-current="page">Parameters Debug</li>
{% endblock %}

{% block content %}
<div class="sticky-debug-header">
    <h1 class="main-title">
      Parameters Debug — {{ language.name_full|default:language.id }} ({{ language.id }})
    </h1>

    <div class="toolbar">
        <a class="btn" href="{% url 'language_data' language.id %}">Back to language data</a>

        {# Run DAG (Apply implications) #}
        <form method="post" action="{% url 'language_run_dag' language.id %}" class="d-inline" aria-label="Apply implications">
          {% csrf_token %}
          <button type="submit" class="btn btn--primary" aria-live="polite">
            Apply implications
          </button>
        </form>
    </div>
</div>

<table class="table">
  <thead>
    <tr>
      <th class="w-1ch">#</th>
      <th class="w-5ch">Label</th>
      <th>Questions</th>
      <th>Answers</th>
      <th class="w-10ch nowrap">Initial value</th>
      <th class="w-8ch">Warn (init)</th>
      <th>Implicational condition(s)</th>
      <th class="w-10ch">Check</th>
      <th class="w-10ch">Final value</th>
      <th class="w-8ch">Warn (final)</th>
    </tr>
  </thead>
  <tbody>
    {% for r in rows %}
      <tr id="{{ r.param_id }}">
        <td>{{ r.position }}</td>
        <td>
          <a href="{% url 'language_data' language.id %}#p-{{ r.param_id }}"
             title="Edit data for {{ r.param_id }}"
             style="text-decoration: underline; color: inherit; font-weight: bold;">
            {{ r.param_id }}
          </a>
        </td>
        <td>
          {% if r.questions %}
            {% for qid in r.questions %}<div><code>{{ qid }}</code></div>{% endfor %}
          {% else %}<span class="muted">—</span>{% endif %}
        </td>
        <td>
          {% if r.answers %}
            {% for a in r.answers %}<div>{{ a }}</div>{% endfor %}
          {% else %}<span class="muted">—</span>{% endif %}
        </td>
        <td class="num nowrap">
          {% if r.initial == '+' %}+{% elif r.initial == '-' %}-{% else %}<span class="muted"> </span>{% endif %}
        </td>
        <td data-label="Warn (init)">
          {% if r.warn_init %}<span class="badge b-bad">⚠</span>{% else %}<span class="muted"></span>{% endif %}
        </td>
        <td>
          {% if r.cond %}<div><code>{{ r.cond }}</code></div>{% else %}<span class="muted">—</span>{% endif %}
        </td>
        <td>
          {% if r.cond_true is True %}<span class="badge b-good">TRUE</span>
          {% elif r.cond_true is False %}<span class="badge b-bad">FALSE</span>
          {% else %}<span class="muted">—</span>{% endif %}
        </td>
        <td class="num nowrap">
          {% if r.final == '+' %}+{% elif r.final == '-' %}-{% elif r.final == '0' %}0{% else %}<span class="muted"> </span>{% endif %}
        </td>
        <td data-label="Warn (final)">
          {% if r.warn_final %}<span class="badge b-bad">⚠</span>{% else %}<span class="muted"></span>{% endif %}
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>

<style>
/* ==========================================
   STILE UNIFICATO GLASS EFFECT (FLOATING)
   ========================================== */

.sticky-debug-header {
  position: sticky;
  top: 1rem; /* Lo stacca dal bordo superiore per mostrare l'arrotondamento */
  z-index: 1000;
  padding: 1.25rem 1.5rem;
  margin-bottom: 2rem;

  /* Arrotondamento coerente con il sito */
  border-radius: var(--radius, 12px);
  border: 1px solid var(--border, #dadde2);

  /* Effetto Vetro - Light Mode */
  background: rgba(255, 255, 255, 0.7);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
}

/* Fix Tema Scuro */
:root[data-theme="dark"] .sticky-debug-header {
  background: rgba(21, 23, 27, 0.7);
  border-color: rgba(255, 255, 255, 0.1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
}

.sticky-debug-header .main-title {
  margin: 0 0 1rem 0;
  padding: 0;
  font-size: var(--fs-4);
  color: var(--text); /* Forza il colore corretto per evitare il bianco su bianco */
}

.sticky-debug-header .toolbar {
  display: flex;
  gap: 0.75rem;
  flex-wrap: wrap;
  margin-bottom: 0; /* Rimuove il margine della toolbar standard */
}

/* Rimuove l'intestazione sticky della tabella come richiesto */
.table thead th {
  position: static;
  background: var(--surface-2);
}

/* Miglioria estetica tabella */
.table {
  border-collapse: separate;
  border-spacing: 0;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function() {
  if (window.location.hash) {
    const targetId = window.location.hash.substring(1);
    const targetElement = document.getElementById(targetId);

    if (targetElement) {
      // Piccolo timeout per attendere il rendering della tabella
      setTimeout(() => {
        targetElement.scrollIntoView({
          behavior: 'smooth',
          block: 'center' // <--- Centra la riga verticalmente
        });

        // Feedback visivo: evidenzia la riga per 2 secondi
        targetElement.style.transition = 'background-color 0.5s';
        targetElement.style.backgroundColor = 'var(--pill-warn-bg)';
        setTimeout(() => {
          targetElement.style.backgroundColor = '';
        }, 2000);
      }, 200);
    }
  }
});
</script>
    <style>
/* --- MOBILE DEBUG LAYOUT (< 900px) --- */
@media (max-width: 900px) {

  /* 1. Resetta la tabella in blocchi */
  .table thead { display: none; } /* Via l'intestazione classica */

  .table tbody tr {
    display: grid;
    /* Definiamo una griglia a 2 colonne */
    grid-template-columns: 1fr 1fr;
    gap: 0.75rem;
    padding: 1.25rem;
    margin-bottom: 1rem;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    position: relative; /* Per posizionamenti assoluti */
    box-shadow: 0 2px 5px rgba(0,0,0,0.03);
  }

  /* Resetta le celle */
  .table tbody td {
    display: block;
    padding: 0;
    border: none;
    width: auto;
  }

  /* --- POSIZIONAMENTO CELLE NELLA GRIGLIA --- */

  /* [POSIZIONE #] - In alto a destra assoluto */
  .table tbody td:nth-child(1) {
    position: absolute;
    top: 1rem;
    right: 1rem;
    font-size: 0.8rem;
    color: var(--text-muted);
    font-family: var(--mono);
    font-weight: bold;
    opacity: 0.6;
  }
  .table tbody td:nth-child(1)::before { content: "#"; }

  /* [LABEL / ID] - Titolo grande (colonna 2 originale) */
  .table tbody td:nth-child(2) {
    grid-column: 1 / -1; /* Tutta la larghezza */
    grid-row: 1;
    font-size: 1.25rem;
    font-weight: 800;
    margin-bottom: 0.5rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border);
  }
  .table tbody td:nth-child(2) a {
    color: var(--brand);
    text-decoration: none !important;
  }

  /* --- SEZIONE Q & A (Domande e Risposte) --- */

  /* [QUESTIONS] - Colonna Sinistra */
  .table tbody td:nth-child(3) {
    grid-column: 1;
    grid-row: 2;
    font-family: var(--mono);
    font-size: 0.85rem;
    color: var(--text-muted);
  }
  .table tbody td:nth-child(3)::before {
    content: "Questions";
    display: block;
    font-size: 0.7rem;
    text-transform: uppercase;
    font-weight: bold;
    margin-bottom: 2px;
    color: var(--text-muted);
  }

  /* [ANSWERS] - Colonna Destra */
  .table tbody td:nth-child(4) {
    grid-column: 2;
    grid-row: 2;
    text-align: right;
    font-weight: 600;
  }
  .table tbody td:nth-child(4)::before {
    content: "Answers";
    display: block;
    font-size: 0.7rem;
    text-transform: uppercase;
    font-weight: bold;
    margin-bottom: 2px;
    color: var(--text-muted);
    text-align: right;
  }

  /* --- SEZIONE VALORI (Initial vs Final) --- */

  /* Wrapper visivo per Initial Value */
  .table tbody td:nth-child(5) {
    grid-column: 1;
    grid-row: 3;
    background: var(--surface-2);
    padding: 0.5rem;
    border-radius: 6px;
    text-align: center;
    margin-top: 0.5rem;
  }
  .table tbody td:nth-child(5)::before {
    content: "Initial Val";
    display: block;
    font-size: 0.65rem;
    text-transform: uppercase;
    opacity: 0.7;
  }

  /* Icona Warn Initial (sovrapposta o vicina) */
  .table tbody td:nth-child(6) {
    grid-column: 1;
    grid-row: 3;
    pointer-events: none; /* Per non disturbare il click */
    display: flex;
    justify-content: flex-end;
    align-items: start;
    margin-top: 0.2rem;
    margin-right: 0.2rem;
  }

  /* Wrapper visivo per Final Value (Più evidente) */
  .table tbody td:nth-child(9) {
    grid-column: 2;
    grid-row: 3;
    background: var(--surface-2); /* O un colore brand light se vuoi */
    border: 1px solid var(--brand); /* Bordo colorato per evidenziare il risultato */
    padding: 0.5rem;
    border-radius: 6px;
    text-align: center;
    font-weight: bold;
    font-size: 1.1rem;
    margin-top: 0.5rem;
  }
  .table tbody td:nth-child(9)::before {
    content: "Final Val";
    display: block;
    font-size: 0.65rem;
    text-transform: uppercase;
    opacity: 0.7;
    font-weight: normal;
  }

  /* Icona Warn Final */
  .table tbody td:nth-child(10) {
    grid-column: 2;
    grid-row: 3;
    pointer-events: none;
    display: flex;
    justify-content: flex-end;
    align-items: start;
    margin-top: 0.2rem;
    margin-right: 0.2rem;
  }

  /* --- SEZIONE LOGICA (Implications) --- */

  /* [CONDITION] - Il codice dell'implicazione */
  .table tbody td:nth-child(7) {
    grid-column: 1 / -1; /* Full width */
    grid-row: 4;
    background: #2a2f37; /* Sfondo scuro per effetto 'terminale' */
    color: #a8b3cf;
    padding: 0.75rem;
    border-radius: 6px;
    font-family: var(--mono);
    font-size: 0.8rem;
    margin-top: 0.5rem;
    word-break: break-all;
    position: relative;
  }
  /* Nascondiamo se vuoto */
  .table tbody td:nth-child(7):empty { display: none; }

  .table tbody td:nth-child(7)::before {
    content: "Logic:";
    display: block;
    font-size: 0.6rem;
    color: #666;
    margin-bottom: 2px;
  }

  /* [CHECK] - Risultato implicazione (TRUE/FALSE) */
  .table tbody td:nth-child(8) {
    grid-column: 1 / -1;
    grid-row: 5;
    text-align: right;
    margin-top: -2.5rem; /* Trucco: lo spostiamo sopra il blocco nero della logica */
    margin-right: 0.5rem;
    z-index: 2; /* Sopra il background */
  }
}
</style>
{% endblock %}