{% extends "base.html" %}
{% load static %}

{% block title %}Language data{% endblock %}
{% block breadcrumb %}Languages / {{ language.id }} / Data{% endblock %}

{% block extra_head %}
  <script src="{% static 'js/show_motivation.js' %}"></script>
  <script src="{% static 'js/examples.js' %}"></script>
{% endblock %}

{% block content %}
  <div class="split">
    <aside class="card sidebar" aria-label="Parameters">
      <h3>Parameters</h3>
      <ul>
        {% for p in parameters %}
          <li>
            {% with status=p.status %}
              {% if status == "ok" %}
                <span class="badge b-ok">OK</span>
              {% elif status == "warn" %}
                <span class="badge">Partial</span>
              {% else %}
                <span class="badge b-bad">Missing</span>
              {% endif %}
            {% endwith %}
            <a href="#p-{{ p.id }}">{{ p.id }} — {{ p.name }}</a>
          </li>
        {% endfor %}
      </ul>

      <div class="toolbar">
        {% if is_admin %}
          <a class="btn" href="{% url 'language_debug' language.id %}">Parameters debug</a>
        {% endif %}
        <a class="btn" href="{% url 'language_export' language.id %}">Export .xlsx</a>
      </div>
    </aside>

    <main>
      <div class="card">
        <h2>{{ language.name_full }} ({{ language.id }})</h2>
        <p class="muted">Answer the questions below. Any “Save” button saves ALL visible fields.</p>

        {% with s=lang_status.overall %}
          <div class="muted" role="status" aria-live="polite" style="margin-top:.25rem">
            <strong>Status:</strong>
            {% if s == "approved" %}
              <span class="badge b-ok">Approved</span>
            {% elif s == "waiting_for_approval" %}
              <span class="badge">Waiting for approval</span>
            {% elif s == "rejected" %}
              <span class="badge b-bad">Rejected</span>
            {% else %}
              <span class="badge">Pending</span>
            {% endif %}
            {% if not all_answered %}
              — <span class="muted">There are unanswered questions.</span>
            {% endif %}
          </div>

          {% if last_reject %}
            <div class="card" role="note" aria-label="Rejection message" style="margin-top:.5rem">
              <strong>Last reject message</strong>
              {% if last_reject.message %}
                <p class="muted" style="white-space:pre-wrap">{{ last_reject.message }}</p>
              {% else %}
                <p class="muted">No message provided.</p>
              {% endif %}
              <p class="muted">By {{ last_reject.created_by }} — {{ last_reject.created_at }}</p>
            </div>
          {% endif %}

          <div class="toolbar" style="margin-top:.5rem; gap:.5rem; flex-wrap:wrap">
            {# --- User: submit finale SEMPRE visibile e cliccabile se non è approved --- #}
            {% if not is_admin and s != "approved" %}
              <form method="post" action="{% url 'language_submit' language.id %}" style="display:inline">
                {% csrf_token %}
                <button class="btn btn--primary" type="submit">Termina compilazione e invia</button>
              </form>
              {% if not all_answered %}
                <span class="muted" role="alert">You can submit even if some answers are missing. Admin approval will be required.</span>
              {% endif %}
            {% endif %}

            {# --- User: riapri se rejected --- #}
            {% if not is_admin and s == "rejected" %}
              <form method="post" action="{% url 'language_reopen' language.id %}" style="display:inline">
                {% csrf_token %}
                <button class="btn" type="submit">Riapri compilazione</button>
              </form>
            {% endif %}

            {# --- Admin: Approva SEMPRE visibile ma DISABILITATO se non completo --- #}
            {% if is_admin %}
              <form method="post" action="{% url 'language_approve' language.id %}" style="display:inline">
                {% csrf_token %}
                <button class="btn btn--primary" type="submit" {% if not all_answered %}disabled aria-disabled="true" title="Completa tutte le risposte per avviare il DAG"{% endif %}>
                  Approva e avvia DAG
                </button>
              </form>

              {# --- Admin: Reject SEMPRE visibile e cliccabile con messaggio facoltativo --- #}
              <form method="post" action="{% url 'language_reject' language.id %}" style="display:inline; display:flex; align-items:flex-start; gap:.5rem; flex-wrap:wrap; max-width:100%">
                {% csrf_token %}
                <label for="reject_message" class="sr-only">Messaggio (facoltativo)</label>
                <textarea id="reject_message" name="message" rows="2" placeholder="Motiva il rifiuto (facoltativo)" style="min-width:16rem; flex:1 1 16rem"></textarea>
                <button class="btn" type="submit">Reject (riapri all’utente)</button>
              </form>
            {% endif %}
          </div>
        {% endwith %}
      </div>

      <form method="post" action="{% url 'answers_bulk_save' language.id %}">
        {% csrf_token %}

        {% for p in parameters %}
        <div id="p-{{ p.id }}" class="card">
          <h3>{{ p.id }} — {{ p.name }}</h3>
          {% if p.short_description %}
            <p class="muted">{{ p.short_description }}</p>
          {% endif %}

          {% for q in p.questions.all %}
          <div class="card">
            <p><strong>{{ q.id }}</strong> — {{ q.text }}</p>
            {% if q.instruction %}<p class="muted">{{ q.instruction }}</p>{% endif %}

            <div class="grid grid-3">
              <div>
                <label for="resp_{{ q.id }}">Answer</label>
                <select id="resp_{{ q.id }}" name="response_text_{{ q.id }}" class="resp-select" data-question-id="{{ q.id }}"
                        {% if not is_admin and lang_status.overall == 'waiting_for_approval' or not is_admin and lang_status.overall == 'approved' %}disabled{% endif %}>
                  <option value="" {% if q.ans.response_text == "" %}selected{% endif %}>— seleziona —</option>
                  <option value="yes" {% if q.ans.response_text == "yes" %}selected{% endif %}>YES</option>
                  <option value="no"  {% if q.ans.response_text == "no"  %}selected{% endif %}>NO</option>
                </select>
              </div>

              <div>
                <label for="com_{{ q.id }}">Comments</label>
                <input id="com_{{ q.id }}" name="comments_{{ q.id }}" value="{{ q.ans.comments }}"
                       {% if not is_admin and lang_status.overall == 'waiting_for_approval' or not is_admin and lang_status.overall == 'approved' %}readonly{% endif %}>
              </div>

              <div class="mot-block" data-qid="{{ q.id }}" {% if q.ans.response_text != "no" %}style="display:none"{% endif %}>
                <label for="mot_{{ q.id }}">Motivations (if NO)</label>
                <select
                  id="mot_{{ q.id }}"
                  name="motivation_ids_{{ q.id }}"
                  multiple
                  size="4"
                  aria-describedby="hint_mot_{{ q.id }}"
                  {% if q.ans.response_text != "no" or not is_admin and lang_status.overall == 'waiting_for_approval' or not is_admin and lang_status.overall == 'approved' %}disabled{% endif %}
                  data-question-id="{{ q.id }}"
                >
                  {% for m in q.allowed_motivations_list %}
                    <option value="{{ m.id }}" {% if m.id in q.ans.motivation_ids %}selected{% endif %}>{{ m.label }}</option>
                  {% endfor %}
                </select>
                <div id="hint_mot_{{ q.id }}" class="muted">Hold Ctrl/Cmd to select multiple.</div>
              </div>
            </div>

            {# --- BLOCCO ESEMPI: visibile solo se YES --- #}
            <div class="examples-block"
                 data-qid="{{ q.id }}"
                 data-template="{{ q.template_type|default:'' }}"
                 {% if q.ans.response_text != "yes" %}style="display:none"{% endif %}>
              <div class="toolbar" style="margin:.5rem 0">
                <strong>Examples</strong>
                <span class="sr-only examples-hint" aria-live="polite"></span>
                <button class="btn add-example-btn"
                        data-qid="{{ q.id }}"
                        data-template="{{ q.template_type|default:'' }}"
                        type="button"
                        {% if not is_admin and lang_status.overall == 'waiting_for_approval' or not is_admin and lang_status.overall == 'approved' %}disabled{% endif %}>
                  Add example
                </button>
              </div>

              <div class="examples-list" data-qid="{{ q.id }}">
                {% for ex in q.ans.examples %}
                  <div class="card example-row" style="margin-bottom:.5rem">
                    <div class="grid">
                      <div>
                        <label for="ex_{{ ex.id }}_number">Number</label>
                        <input id="ex_{{ ex.id }}_number" name="ex_{{ ex.id }}_number" value="{{ ex.number }}" readonly>
                      </div>
                      <div>
                        <label for="ex_{{ ex.id }}_textarea">Data</label>
                        <input id="ex_{{ ex.id }}_textarea" name="ex_{{ ex.id }}_textarea" value="{{ ex.textarea }}"
                              {% if not is_admin and lang_status.overall == 'waiting_for_approval' or not is_admin and lang_status.overall == 'approved' %}readonly{% endif %}>
                      </div>
                      <div>
                        <label for="ex_{{ ex.id }}_transliteration">Transliteration</label>
                        <input id="ex_{{ ex.id }}_transliteration" name="ex_{{ ex.id }}_transliteration" value="{{ ex.transliteration }}"
                              {% if not is_admin and lang_status.overall == 'waiting_for_approval' or not is_admin and lang_status.overall == 'approved' %}readonly{% endif %}>
                      </div>
                      <div>
                        <label for="ex_{{ ex.id }}_gloss">Gloss</label>
                        <input id="ex_{{ ex.id }}_gloss" name="ex_{{ ex.id }}_gloss" value="{{ ex.gloss }}"
                              {% if not is_admin and lang_status.overall == 'waiting_for_approval' or not is_admin and lang_status.overall == 'approved' %}readonly{% endif %}>
                      </div>
                      <div>
                        <label for="ex_{{ ex.id }}_translation">English translation</label>
                        <input id="ex_{{ ex.id }}_translation" name="ex_{{ ex.id }}_translation" value="{{ ex.translation }}"
                              {% if not is_admin and lang_status.overall == 'waiting_for_approval' or not is_admin and lang_status.overall == 'approved' %}readonly{% endif %}>
                      </div>
                      <div>
                        <label for="ex_{{ ex.id }}_reference">Reference</label>
                        <input id="ex_{{ ex.id }}_reference" name="ex_{{ ex.id }}_reference" value="{{ ex.reference }}"
                              {% if not is_admin and lang_status.overall == 'waiting_for_approval' or not is_admin and lang_status.overall == 'approved' %}readonly{% endif %}>
                      </div>
                    </div>
                    <div class="toolbar" style="margin-top:.25rem">
                      <input type="hidden" name="del_ex_{{ ex.id }}" value="0">
                      <button class="btn btn-ex-toggle-delete"
                              type="button"
                              data-qid="{{ q.id }}"
                              data-exid="{{ ex.id }}"
                              {% if not is_admin and lang_status.overall == 'waiting_for_approval' or not is_admin and lang_status.overall == 'approved' %}disabled{% endif %}>
                        Delete
                      </button>
                      <span class="sr-only ex-del-hint" aria-live="polite"></span>
                    </div>
                  </div>
                {% empty %}
                  <div class="muted">No examples yet</div>
                {% endfor %}
              </div>
            </div>

            {% if is_admin or lang_status.overall == 'pending' or lang_status.overall == 'rejected' %}
              <div class="toolbar">
                <button class="btn btn--primary" type="submit">Save</button>
              </div>
            {% endif %}
          </div>
          {% endfor %}
        </div>
        {% endfor %}

        {% if is_admin or lang_status.overall == 'pending' or lang_status.overall == 'rejected' %}
          <div class="toolbar" style="margin-top:1rem">
            <button class="btn btn--primary" type="submit">Save all</button>
          </div>
        {% endif %}
      </form>

      <div class="toolbar" style="margin-top:1rem; gap:.5rem; flex-wrap:wrap">
        {% with s=lang_status.overall %}
          {% if not is_admin and s != "approved" %}
            <form method="post" action="{% url 'language_submit' language.id %}" style="display:inline">
              {% csrf_token %}
              <button class="btn btn--primary" type="submit">Termina compilazione e invia</button>
            </form>
            {% if not all_answered %}
              <span class="muted" role="alert">You can submit even if some answers are missing.</span>
            {% endif %}
          {% endif %}

          {% if not is_admin and s == "rejected" %}
            <form method="post" action="{% url 'language_reopen' language.id %}" style="display:inline">
              {% csrf_token %}
              <button class="btn" type="submit">Riapri compilazione</button>
            </form>
          {% endif %}

          {% if is_admin %}
            <form method="post" action="{% url 'language_approve' language.id %}" style="display:inline">
              {% csrf_token %}
              <button class="btn btn--primary" type="submit" {% if not all_answered %}disabled aria-disabled="true" title="Completa tutte le risposte per avviare il DAG"{% endif %}>
                Approva e avvia DAG
              </button>
            </form>
            <form method="post" action="{% url 'language_reject' language.id %}" style="display:inline; display:flex; align-items:flex-start; gap:.5rem; flex-wrap:wrap; max-width:100%">
              {% csrf_token %}
              <label for="reject_message_bottom" class="sr-only">Messaggio (facoltativo)</label>
              <textarea id="reject_message_bottom" name="message" rows="2" placeholder="Motiva il rifiuto (facoltativo)" style="min-width:16rem; flex:1 1 16rem"></textarea>
              <button class="btn" type="submit">Reject (riapri all’utente)</button>
            </form>
          {% endif %}
        {% endwith %}
      </div>
    </main>
  </div>
{% endblock %}
