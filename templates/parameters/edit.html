{% extends "base.html" %}
{% load i18n %}

{% block title %}{% if is_create %}Add parameter{% else %}Edit parameter{% endif %}{% endblock %}
{% block breadcrumb %}Parameters / {% if is_create %}Add{% else %}{{ parameter.id }}{% endif %}{% endblock %}

{% block content %}
<section class="card" aria-labelledby="param-heading">
  <h2 id="param-heading">{% if is_create %}Add parameter{% else %}Parameter {{ parameter.id }}{% endif %}</h2>

  <form method="post" novalidate>
    {% csrf_token %}

  {% if is_create %}
    <div class="form-row">
      {{ form.id.label_tag }} {{ form.id }}
      {% if form.id.errors %}<div class="form-error">{{ form.id.errors }}</div>{% endif %}
    </div>
  {% else %}
    <div class="form-row">
      {{ form.id.label_tag }}
      <input class="form-control" value="{{ form.id.value|default_if_none:'' }}" readonly>
      {{ form.id.as_hidden }}
      <p class="muted">ID non modificabile.</p>
    </div>
  {% endif %}


    <div class="form-row">
      {{ form.name.label_tag }} {{ form.name }}
      {% if form.name.errors %}<div class="form-error">{{ form.name.errors }}</div>{% endif %}
    </div>

    <div class="form-row">
      {{ form.short_description.label_tag }} {{ form.short_description }}
      {% if form.short_description.errors %}<div class="form-error">{{ form.short_description.errors }}</div>{% endif %}
    </div>

    <div class="form-row">
      {{ form.implicational_condition.label_tag }} {{ form.implicational_condition }}
      {% if form.implicational_condition.errors %}<div class="form-error">{{ form.implicational_condition.errors }}</div>{% endif %}
      <p class="help">Usa token tipo <code>+FGM</code>, <code>-SCO</code>, <code>0ABC</code>, senza spazi tra segno e ID.</p>
    </div>

    <div class="form-row">
      <label for="{{ form.is_active.id_for_label }}">Active</label>
      <input
        id="{{ form.is_active.id_for_label }}"
        name="{{ form.is_active.html_name }}"
        type="checkbox"
        value="1"
        {% if form.instance.is_active %}checked{% endif %}
        {% if not can_deactivate and form.instance.is_active %}disabled aria-disabled="true"{% endif %}
      />
      {% if form.is_active.errors %}<div class="form-error">{{ form.is_active.errors }}</div>{% endif %}

      {% if form.instance.is_active and not can_deactivate %}
        <p class="hint b-bad" role="note">
          Non disattivabile: esistono parametri che citano questo ID.
          Consulta l’elenco qui sotto e ripulisci manualmente le condizioni degli altri parametri.
        </p>
      {% endif %}
    </div>

    <div class="form-row">
      {{ form.position.label_tag }} {{ form.position }}
      {% if form.position.errors %}<div class="form-error">{{ form.position.errors }}</div>{% endif %}
    </div>

    <div class="form-row">
      <label class="sr-only" for="{{ form.warning_default.id_for_label }}">Warning default</label>
      {{ form.warning_default }}
      {% if form.warning_default.errors %}<div class="form-error">{{ form.warning_default.errors }}</div>{% endif %}
    </div>

    <div class="actions">
      <button type="submit" class="btn btn--primary">Save</button>
      <a class="btn" href="{% url 'parameter_list' %}">Back</a>
    </div>
  </form>
</section>

<section class="card" aria-labelledby="where-used-heading">
  <h3 id="where-used-heading">Who references this parameter</h3>
  {% if where_used and where_used|length > 0 %}
    <p class="muted">I seguenti parametri citano questo ID nella loro implicational condition. Modifica le loro condizioni prima di poter disattivare.</p>
    <ul class="list">
      {% for target, cond in where_used %}
        <li>
          <a href="{% url 'parameter_edit' target.id %}"><strong>{{ target.id }}</strong> — {{ target.name }}</a>
          <div class="muted"><code>{{ cond }}</code></div>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="muted">Nessuno cita questo parametro. È possibile procedere alla disattivazione, previo inserimento password.</p>
  {% endif %}
</section>

{% if can_deactivate %}
<section class="card" aria-labelledby="deactivate-heading">
  <h3 id="deactivate-heading">Disattiva parametro</h3>
  <p>Questa azione rende il parametro inattivo. Conferma con la tua password.</p>
  <form method="post" action="{% url 'parameter_deactivate' parameter.id %}" novalidate>
    {% csrf_token %}
    <div class="form-row">
      {{ deactivate_form.password.label_tag }}
      {{ deactivate_form.password }}
      {% if deactivate_form.password.errors %}<div class="form-error">{{ deactivate_form.password.errors }}</div>{% endif %}
    </div>
    <div class="form-row">
      {{ deactivate_form.reason.label_tag }}
      {{ deactivate_form.reason }}
      {% if deactivate_form.reason.errors %}<div class="form-error">{{ deactivate_form.reason.errors }}</div>{% endif %}
    </div>
    {% if deactivate_form.non_field_errors %}
      <div class="form-error">{{ deactivate_form.non_field_errors }}</div>
    {% endif %}
    <div class="actions">
      <button type="submit" class="btn btn--danger">Conferma disattivazione</button>
    </div>
  </form>
</section>
{% endif %}
{% endblock %}
