{# templates/base.html — base pulita, tema chiaro/scuro, header + breadcrumb #}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <!-- THEME: early apply (no flash) -->
  <script>
    (function () {
      try {
        var stored = localStorage.getItem('theme'); // 'light' | 'dark' | null
        var theme = stored || (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        document.documentElement.setAttribute('data-theme', theme);
        document.documentElement.style.colorScheme = theme;
      } catch (e) {
        document.documentElement.setAttribute('data-theme', 'light');
        document.documentElement.style.colorScheme = 'light';
      }
    })();
  </script>
  <meta name="color-scheme" content="light dark">

  <title>{% block title %}Parametric Comparison Method (PCM){% endblock %}</title>
  {% load static %}
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
  <link rel="stylesheet" href="{% static 'css/mobile.css' %}" media="(max-width: 768px)">
  {% block extra_head %}{% endblock %}
</head>

<body class="{% block body_class %}{% endblock %}">

  <!-- HEADER -->
  <header class="site-header">
    <div class="container">
      <h1 class="site-title">
        PCM Hub
        <span class="site-subtitle">Parametric Comparison Method (PCM) – Data collection and storage</span>
      </h1>

      {% with urln=request.resolver_match.url_name|default:'' %}
      <nav class="nav" aria-label="Main">
        <ul class="nav-list">

          {# Link principali #}
          <li>
            {% if urln == 'dashboard' %}
              <span class="btn is-current" aria-current="page" aria-disabled="true">Dashboard</span>
            {% else %}
              <a class="btn" href="{% url 'dashboard' %}">Dashboard</a>
            {% endif %}
          </li>

          <li>
            {% if urln == 'language_list' or urln == 'language_add' or urln == 'language_edit' or urln == 'language_data' %}
              <span class="btn is-current" aria-current="page" aria-disabled="true">Languages</span>
            {% else %}
              <a class="btn" href="{% url 'language_list' %}">Languages</a>
            {% endif %}
          </li>

          <li>
            {% if urln == 'glossary_list' or urln == 'glossary_edit' or urln == 'glossary_add' %}
              <span class="btn is-current" aria-current="page" aria-disabled="true">Glossary</span>
            {% else %}
              <a class="btn" href="{% url 'glossary_list' %}">Glossary</a>
            {% endif %}
          </li>

          {% if not request.user.is_staff and not request.user.is_superuser and request.user.role != 'admin' %}
            <li>
              {% if urln == 'my_account' %}
                <span class="btn is-current" aria-current="page" aria-disabled="true">My Account</span>
              {% else %}
                <a class="btn" href="{% url 'my_account' %}">My Account</a>
              {% endif %}
            </li>
          {% endif %}

          {% if request.user.is_staff or request.user.is_superuser or request.user.role == 'admin' %}
            <li>
              {% if urln == 'parameter_list' or urln == 'parameter_edit' or urln == 'parameter_add' %}
                <span class="btn is-current" aria-current="page" aria-disabled="true">Parameters</span>
              {% else %}
                <a class="btn" href="{% url 'parameter_list' %}">Parameters</a>
              {% endif %}
            </li>

            <li>
              {% if urln == 'tablea_index' %}
                <span class="btn is-current" aria-current="page" aria-disabled="true">Table A</span>
              {% else %}
                <a class="btn" href="{% url 'tablea_index' %}">Table A</a>
              {% endif %}
            </li>

            <li>
              {% if urln|slice:":7" == 'queries' %}
                <span class="btn is-current" aria-current="page" aria-disabled="true">Queries</span>
              {% else %}
                <a class="btn" href="{% url 'queries:home' %}">Queries</a>
              {% endif %}
            </li>

            <li>
              {% if urln == 'submissions_list' or urln == 'submission_detail' %}
                <span class="btn is-current" aria-current="page" aria-disabled="true">Submissions</span>
              {% else %}
                <a class="btn" href="{% url 'submissions_list' %}">Submissions</a>
              {% endif %}
            </li>

            <li>
              {% if urln == 'accounts_list' or urln == 'account_edit' or urln == 'account_add' %}
                <span class="btn is-current" aria-current="page" aria-disabled="true">Accounts</span>
              {% else %}
                <a class="btn" href="{% url 'accounts_list' %}">Accounts</a>
              {% endif %}
            </li>
          {% endif %}

          {# Spaziatore elastico che crea buco e spinge Logout/Theme a destra #}
          <li class="nav-spacer" aria-hidden="true"></li>

          {# Gruppo sessione (logout + tema), visivamente separato #}
          <li class="nav-session">
            <form action="{% url 'logout' %}" method="post" aria-label="Logout" style="display:inline">{% csrf_token %}
              <button class="btn" type="submit">Logout</button>
            </form>

            <button id="theme-toggle"
                    type="button"
                    class="btn theme-toggle"
                    aria-label="Toggle theme"
                    aria-live="polite"
                    aria-pressed="false"></button>
          </li>

        </ul>

      </nav>
      {% endwith %}

      <nav class="breadcrumb" aria-label="Breadcrumb">
        {% block breadcrumb %}<span>Dashboard</span>{% endblock %}
      </nav>
    </div>
  </header>

  <a href="#main" class="sr-only">Skip to main content</a>

  <!-- FLASH MESSAGES -->
  <section role="status" aria-live="polite" aria-atomic="true">
    {% include "_partials/messages.html" %}
  </section>

  <!-- MAIN -->
  <main id="main" role="main" tabindex="-1">
    <div class="container">
      {% block content %}{% endblock %}
    </div>
  </main>

  <!-- FOOTER -->
  {% block footer %}
  <footer class="site-footer" role="contentinfo">
    <div class="container">
      <p class="muted">© {% now "Y" %} – Admin area</p>
    </div>
  </footer>
  {% endblock %}

  {% block extra_js %}{% endblock %}
  <script>
    (function () {
      var root = document.documentElement;
      var btn = document.getElementById('theme-toggle');
      if (!btn) return;

      function currentTheme() {
        return root.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
      }
      function setTheme(next) {
        root.setAttribute('data-theme', next);
        root.style.colorScheme = next;
        try { localStorage.setItem('theme', next); } catch (e) {}
        updateButton(next);
      }
      function updateButton(theme) {
        // Usa caratteri Unicode diretti
        var icon = theme === 'dark'
          ? 'Light'  
          : 'Dark'; 
        btn.textContent = icon;
        btn.setAttribute('aria-pressed', theme === 'dark' ? 'true' : 'false');
        btn.setAttribute('aria-label', 'Toggle theme');
        btn.title = theme === 'dark' ? 'Light theme' : 'Dark theme';
      }
      updateButton(currentTheme());
      btn.addEventListener('click', function () {
        var next = currentTheme() === 'dark' ? 'light' : 'dark';
        setTheme(next);
      });
      try {
        if (!localStorage.getItem('theme') && window.matchMedia) {
          var mq = window.matchMedia('(prefers-color-scheme: dark)');
          mq.addEventListener('change', function (e) {
            setTheme(e.matches ? 'dark' : 'light');
          });
        }
      } catch (e) {}
    })();
  </script>

  <button id="backToTop" class="back-to-top is-hidden" type="button" aria-label="Torna su" title="Torna su">↑</button>
  <script src="{% static 'js/back_to_top.js' %}"></script>
  <script src="{% static 'js/messages.js' %}" defer></script>
</body>
</html>
