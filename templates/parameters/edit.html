{% extends "base.html" %}
{% load i18n %}
{% load static %}

{% block title %}{% if is_create %}Add parameter{% else %}Edit parameter{% endif %}{% endblock %}
{% block breadcrumb %}Parameters / {% if is_create %}Add{% else %}{{ parameter.id }}{% endif %}{% endblock %}

{% block extra_head %}
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
  <script defer src="{% static 'js/parameter_edit.js' %}"></script>
  <style>
    .q-list { display: grid; gap: .5rem; }
    .q-row {
      display: flex; align-items: flex-start; justify-content: space-between;
      gap: .75rem; padding: .75rem .9rem;
      background: var(--surface, #fff); border: 1px solid var(--border, #dadde2);
      border-radius: .6rem;
    }
    .q-row__text { flex: 1 1 auto; min-width: 0; }
    .q-row__id { font-weight: 600; margin-right: .5rem; white-space: nowrap; }
    .q-row__actions { flex: 0 0 auto; display: inline-flex; gap: .5rem; }
    .q-section-title { margin: .25rem 0 .5rem; color: var(--text-muted,#61656b); font-weight: 600; }
  </style>
{% endblock %}

{% block content %}
<section class="card" aria-labelledby="param-heading">
  <h2 id="param-heading">{% if is_create %}Add parameter{% else %}Edit parameter — {{ parameter.id }}{% endif %}</h2>

  <form id="param-edit-form" method="post" novalidate
        {% if not is_create %}
          data-requires-change-note="true"
          data-change-note-name="{{ form.change_note.html_name|escapejs }}"
        {% endif %}
        data-tracked='[
          "{{ form.name.html_name|escapejs }}",
          "{{ form.short_description.html_name|escapejs }}",
          "{{ form.implicational_condition.html_name|escapejs }}",
          "{{ form.is_active.html_name|escapejs }}",
          "{{ form.position.html_name|escapejs }}"{% if form.warning_default %},
          "{{ form.warning_default.html_name|escapejs }}"{% endif %},
          "{{ form.schema.html_name|escapejs }}",
          "{{ form.param_type.html_name|escapejs }}"
        ]'
        data-external-dirty="{% if external_dirty %}true{% else %}false{% endif %}"
        >
    {% csrf_token %}

    <input type="hidden" name="had_external_changes" value="{% if external_dirty %}1{% else %}0{% endif %}">

    {% if is_create %}
      <div class="form-row">
        <label for="{{ form.id.id_for_label }}">{{ form.id.label }}</label>
        {{ form.id }}
        {% if form.id.errors %}<div class="form-error">{{ form.id.errors }}</div>{% endif %}
      </div>
    {% else %}
      <div class="form-row">
        <label for="{{ form.id.id_for_label }}">{{ form.id.label }}</label>
        <input class="form-control" value="{{ form.id.value|default_if_none:'' }}" readonly>
        {{ form.id.as_hidden }}
      </div>
    {% endif %}

    <div style="display: flex; gap: 1rem; align-items: flex-end;">

      <div class="form-row">
        <label for="{{ form.label.id_for_label }}">{{ form.label.label }}</label>
        {{ form.label }}
        {% if form.label.errors %}<div class="form-error">{{ form.label.errors }}</div>{% endif %}
      </div>

      <div class="form-row">
        <label for="{{ form.position.id_for_label }}">{{ form.position.label }}</label>
        {{ form.position }}
        {% if form.position.errors %}<div class="form-error">{{ form.position.errors }}</div>{% endif %}
      </div>

      <div class="form-row">
        <label for="{{ form.is_active.id_for_label }}">Active</label>
        {% if form.instance.is_active and not can_deactivate %}
          <input
            type="checkbox"
            id="{{ form.is_active.id_for_label }}"
            checked
            disabled
            aria-disabled="true"
          >
          <input type="hidden" name="{{ form.is_active.html_name }}" value="1">
        {% else %}
          {{ form.is_active }}
        {% endif %}
        {% if form.is_active.errors %}<div class="form-error">{{ form.is_active.errors }}</div>{% endif %}
      </div>

    </div>


      <div class="form-row">
        <label for="{{ form.name.id_for_label }}">{{ form.name.label }}</label>
        {{ form.name }}
        {% if form.name.errors %}<div class="form-error">{{ form.name.errors }}</div>{% endif %}
      </div>

      <div class="form-row">
        <label for="{{ form.short_description.id_for_label }}">{{ form.short_description.label }}</label>
        {{ form.short_description }}
        {% if form.short_description.errors %}<div class="form-error">{{ form.short_description.errors }}</div>{% endif %}
      </div>


    <div style="display: flex; gap: 1rem;">
      <div class="form-row" style="flex: 1;">
        <label for="{{ form.schema.id_for_label }}">{{ form.schema.label }}</label>
        {{ form.schema }}
        {% if form.schema.errors %}<div class="form-error">{{ form.schema.errors }}</div>{% endif %}
      </div>

      <div class="form-row" style="flex: 1;">
        <label for="{{ form.param_type.id_for_label }}">{{ form.param_type.label }}</label>
        {{ form.param_type }}
        {% if form.param_type.errors %}<div class="form-error">{{ form.param_type.errors }}</div>{% endif %}
      </div>
    </div>

    <div class="actions" style="margin:.5rem 0 .25rem; text-align: right;">
      <a class="btn" href="{% url 'param_lookups_manage' %}">
        Edit schema & type
      </a>
    </div>


    <div class="form-row">
      <label for="{{ form.implicational_condition.id_for_label }}">{{ form.implicational_condition.label }}</label>
      {{ form.implicational_condition }}
      {% if form.implicational_condition.errors %}<div class="form-error">{{ form.implicational_condition.errors }}</div>{% endif %}
    </div>


    <div class="form-row">
      <label class="sr-only" for="{{ form.warning_default.id_for_label }}">Warning default</label>
      {{ form.warning_default }}
      {% if form.warning_default.errors %}<div class="form-error">{{ form.warning_default.errors }}</div>{% endif %}
    </div>

    {% if not is_create %}

        <div class="grid grid--2">
          <div>
            <label>Questions</label>
            {% if questions_normal and questions_normal|length > 0 %}
              <div class="q-list">
                {% for q in questions_normal %}
                  <div class="q-row">
                    <div class="q-row__text">
                      <span class="q-row__id">{{ q.id }}</span>
                      <span>{{ q.text }}</span>
                    </div>
                    <div class="q-row__actions">
                      <a class="btn" href="{% url 'question_edit' parameter.id q.id %}">Edit</a>
                      <a class="btn" href="{% url 'question_delete' parameter.id q.id %}">Delete</a>
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <p class="muted">No questions</p>
            {% endif %}
          </div>

          <div>
            <label>Stop questions</label>
            {% if questions_stop and questions_stop|length > 0 %}
              <div class="q-list">
                {% for q in questions_stop %}
                  <div class="q-row">
                    <div class="q-row__text">
                      <span class="q-row__id">{{ q.id }}</span>
                      <span>{{ q.text }}</span>
                    </div>
                    <div class="q-row__actions">
                      <a class="btn" href="{% url 'question_edit' parameter.id q.id %}">Edit</a>
                      <a class="btn btn--danger" href="{% url 'question_delete' parameter.id q.id %}">Delete</a>
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <p class="muted">No stop questions</p>
            {% endif %}
          </div>
        </div>

        <div class="actions" style="margin-bottom: .5rem; text-align: right; display:flex; gap:.5rem; justify-content:flex-end; flex-wrap:wrap;">
          <a class="btn" href="{% url 'question_clone' parameter.id %}">
            Import question from another parameter
          </a>
          <a class="btn btn--primary" href="{% url 'question_add' parameter.id %}">
            Add a new question
          </a>
        </div>

    {% endif %}

    {% if not is_create %}
          <label for="{{ form.change_note.id_for_label }}">{{ form.change_note.label }}</label>
          <p id="changeNoteHint" class="help">This field is required only if you modified one or more fields of this parameter</p>
          {{ form.change_note }}
          {% if form.change_note.errors %}<div class="form-error">{{ form.change_note.errors }}</div>{% endif %}
    {% endif %}

    <div class="toolbar" style="display: flex; justify-content: flex-end; gap: 10px;">
      <button id="saveBtn" type="submit" class="btn btn--primary" aria-disabled="false">Save</button>
      <a class="btn" href="{% url 'parameter_list' %}">Cancel</a>
    </div>
  </form>
</section>

<section class="card" aria-labelledby="where-used-heading">
  <h3 id="where-used-heading">Implicational conditions mentioning this parameter</h3>
  {% if where_used and where_used|length > 0 %}
    <p class="muted">The following parameters reference this parameter in their implicational condition(s): edit their implicational condition(s) before deactivating this parameter.</p>
    <ul class="list">
      {% for target, cond in where_used %}
        <li>
          <a href="{% url 'parameter_edit' target.id %}"><strong>{{ target.id }}</strong> — {{ target.name }}</a>
          <div class="muted"><code>{{ cond }}</code></div>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="muted">No implicational conditions mentioning this parameter: you can proceed with deactivation.</p>
  {% endif %}
</section>

{% endblock %}
